<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>SIAP - Sistema Integral de An√°lisis de Procesos</title>
<style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .card h3 {
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 1.3rem;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #4a5568;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s ease;
            width: 100%;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-secundario {
            background: #e2e8f0;
            color: #4a5568;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }

        .nav-tabs {
            display: flex;
            margin-bottom: 20px;
            background: white;
            border-radius: 10px;
            padding: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow-x: auto;
            flex-wrap: wrap;
        }

        .nav-tab {
            flex: 1;
            padding: 10px 8px;
            text-align: center;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-weight: 600;
            white-space: nowrap;
            min-width: 90px;
            font-size: 12px;
            margin: 2px;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .multi-select-container {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px;
            background: #f9f9f9;
            min-height: 50px;
        }

        .multi-select-item {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin: 2px;
            cursor: pointer;
        }

        .multi-select-item .remove {
            margin-left: 5px;
            color: #ff6b6b;
            font-weight: bold;
            cursor: pointer;
        }

        .dropdown-opciones {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 5px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .opcion-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }

        .opcion-item:hover {
            background: #f7fafc;
        }

        .alert {
            background: #fed7d7;
            border: 1px solid #feb2b2;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 600;
        }

        .success {
            background: #c6f6d5;
            border: 1px solid #9ae6b4;
            color: #2f855a;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .stat {
            text-align: center;
            padding: 15px;
            background: #f7fafc;
            border-radius: 10px;
            min-width: 120px;
            margin: 5px;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #4a5568;
            margin-top: 5px;
        }

        .btn-asignar {
            background: #38a169;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 11px;
            margin: 5px;
        }

        .responsable-asignado {
            background: #e3f2fd;
            color: #1976d2;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            margin: 5px 0;
            display: inline-block;
        }

        .deteccion-con-responsable {
            border-left: 4px solid #38a169;
        }

        .deteccion-sin-responsable {
            border-left: 4px solid #e53e3e;
        }

        .matriz-container {
            overflow-x: auto;
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .matriz {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        .matriz th, .matriz td {
            border: 1px solid #e2e8f0;
            padding: 12px;
            text-align: center;
            font-size: 12px;
        }

        .matriz th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }

        .duplicado {
            background-color: #fed7d7 !important;
            color: #c53030;
            font-weight: bold;
        }

        .checkbox-cell {
            padding: 8px;
        }

        .checkbox-cell input[type="checkbox"] {
            transform: scale(1.2);
            cursor: pointer;
        }

        .filtros-analisis {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filtros-analisis label {
            font-weight: bold;
            margin-right: 5px;
        }

        .filtros-analisis select {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        .actividades-gestion {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .actividad-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
        }
        
        .actividad-item.inactiva {
            background: #ffe6e6;
            opacity: 0.7;
        }
        
        .botones-actividad {
            display: flex;
            gap: 5px;
        }
        
        .btn-editar, .btn-estado, .btn-eliminar {
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .btn-editar {
            background: #007bff;
            color: white;
        }
        
        .btn-estado {
            background: #28a745;
            color: white;
        }
        
        .btn-eliminar {
            background: #dc3545;
            color: white;
        }

        .btn-eliminar:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .cambio-item {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .auditoria-info {
            background: #f8f9fa;
            border-radius: 5px;
            padding: 8px 12px;
            margin-top: 8px;
            font-size: 11px;
            color: #666;
            border-left: 3px solid #667eea;
        }

        @media (max-width: 768px) {
            .nav-tabs {
                flex-direction: column;
            }
            
            .nav-tab {
                min-width: auto;
                margin: 1px 0;
            }
            
            .stats {
                flex-direction: column;
            }
            
            .dashboard {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<div class="container">
<div class="header">
<h1>üîç SIAP</h1>
<p>Sistema Integral de An√°lisis de Procesos - Versi√≥n Corregida v5.0</p>
</div>
<div class="nav-tabs">
<div class="nav-tab active" onclick="mostrarSeccion('captura')">üìã Captura</div>
<div class="nav-tab" onclick="mostrarSeccion('configuracion')">‚öôÔ∏è Config</div>
<div class="nav-tab" onclick="mostrarSeccion('usuarios')">üë• Usuarios</div>
<div class="nav-tab" onclick="mostrarSeccion('actividades')">üìù Actividades</div>
<div class="nav-tab" onclick="mostrarSeccion('analisis')">üîç An√°lisis</div>
<div class="nav-tab" onclick="mostrarSeccion('datos')">üìä Datos</div>
<div class="nav-tab" onclick="mostrarSeccion('oportunidades')">üí° Mejoras</div>
<div class="nav-tab" onclick="mostrarSeccion('acciones-mejora')">‚ö° Acciones</div>
<div class="nav-tab" onclick="mostrarSeccion('auditoria')">üìù Auditor√≠a</div>
<div class="nav-tab" onclick="mostrarSeccion('dashboard')">üìà Dashboard</div>
</div>
<!-- TAB 1: CAPTURA -->
<div class="tab-content active" id="captura">
<div class="dashboard">
<div class="card">
<h3>üè¢ Registro de Procesos</h3>
<div class="form-group">
<label>√Årea:</label>
<select id="area">
<option value="">Seleccionar √°rea...</option>
</select>
</div>
<div class="form-group">
<label>Puesto/Responsable:</label>
<select id="puesto">
<option value="">Seleccionar puesto...</option>
</select>
</div>
<div class="form-group">
<label>Proceso:</label>
<input id="proceso" placeholder="Ej: Validaci√≥n de cliente nuevo" type="text"/>
</div>
<div class="form-group">
<label>Descripci√≥n Detallada:</label>
<textarea id="descripcion" placeholder="Describe paso a paso qu√© se hace en este proceso..." rows="3"></textarea>
</div>
<!-- Sistemas como multi-selecci√≥n -->
<div class="form-group">
<label>Sistemas Utilizados:</label>
<div style="position: relative;">
<input id="filtroSistemas" placeholder="üîç Buscar y seleccionar sistemas..." style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 5px;" type="text"/>
<div class="dropdown-opciones" id="sistemasFiltrados"></div>
</div>
<div class="multi-select-container" id="sistemasSeleccionados" style="margin-top: 10px;">
<span style="color: #999; font-style: italic;">No hay sistemas seleccionados</span>
</div>
</div>

<div class="form-group">
<label>Tiempo Estimado (minutos):</label>
<input id="tiempo" placeholder="30" type="number"/>
</div>
<div class="form-group">
<label>Frecuencia:</label>
<select id="frecuencia">
<option value="">Seleccionar frecuencia...</option>
<option>Diario</option>
<option>Semanal</option>
<option>Mensual</option>
<option>Por demanda</option>
</select>
</div>
<!-- Flujo de Informaci√≥n Mejorado -->
<div style="border-top: 2px solid #e2e8f0; margin-top: 20px; padding-top: 20px;">
<h4 style="color: #4a5568; margin-bottom: 15px;">üîó Flujo de Informaci√≥n (Opcional)</h4>
<!-- Informaci√≥n que Recibe -->
<div style="background: #f0fff4; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
<h5 style="color: #38a169; margin-bottom: 10px;">üì• Informaci√≥n que Recibe</h5>
<div class="form-group">
<label>Fuentes de Informaci√≥n:</label>
<div style="position: relative;">
<input id="filtroInfoRecibe" placeholder="üîç Seleccionar fuentes de informaci√≥n..." style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 5px;" type="text"/>
<button onclick="mostrarModalNuevaFuente('recibe')" style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); background: #38a169; color: white; border: none; border-radius: 3px; padding: 4px 8px; font-size: 12px; cursor: pointer;" type="button">‚ûï</button>
<div class="dropdown-opciones" id="fuentesInfoRecibeFiltradas"></div>
</div>
<div class="multi-select-container" id="fuentesInfoRecibeSeleccionadas" style="margin-top: 10px;">
<span style="color: #999; font-style: italic;">No hay fuentes seleccionadas</span>
</div>
</div>
<div class="form-group">
<label>Descripci√≥n Detallada:</label>
<textarea id="descripcionInfoRecibe" placeholder="Describe brevemente qu√© informaci√≥n recibe y c√≥mo la utiliza..." rows="2"></textarea>
</div>
<div class="form-group">
<label>Formato de Recepci√≥n:</label>
<div style="position: relative;">
<input id="filtroFormatoRecibe" placeholder="üîç Seleccionar formatos..." style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 5px;" type="text"/>
<button onclick="mostrarModalNuevoFormato('recibe')" style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); background: #3182ce; color: white; border: none; border-radius: 3px; padding: 4px 8px; font-size: 12px; cursor: pointer;" type="button">‚ûï</button>
<div class="dropdown-opciones" id="formatosRecibeFiltrados"></div>
</div>
<div class="multi-select-container" id="formatosRecibeSeleccionados" style="margin-top: 10px;">
<span style="color: #999; font-style: italic;">No hay formatos seleccionados</span>
</div>
</div>
</div>
<!-- Informaci√≥n que Entrega -->
<div style="background: #fef5e7; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
<h5 style="color: #f59e0b; margin-bottom: 10px;">üì§ Informaci√≥n que Entrega</h5>
<div class="form-group">
<label>Destinos de Informaci√≥n:</label>
<div style="position: relative;">
<input id="filtroInfoEntrega" placeholder="üîç Seleccionar destinos de informaci√≥n..." style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 5px;" type="text"/>
<button onclick="mostrarModalNuevaFuente('entrega')" style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); background: #38a169; color: white; border: none; border-radius: 3px; padding: 4px 8px; font-size: 12px; cursor: pointer;" type="button">‚ûï</button>
<div class="dropdown-opciones" id="destinosInfoEntregaFiltrados"></div>
</div>
<div class="multi-select-container" id="destinosInfoEntregaSeleccionados" style="margin-top: 10px;">
<span style="color: #999; font-style: italic;">No hay destinos seleccionados</span>
</div>
</div>
<div class="form-group">
<label>Descripci√≥n Detallada:</label>
<textarea id="descripcionInfoEntrega" placeholder="Describe brevemente qu√© informaci√≥n entrega y c√≥mo la procesa..." rows="2"></textarea>
</div>
<div class="form-group">
<label>Formato de Entrega:</label>
<div style="position: relative;">
<input id="filtroFormatoEntrega" placeholder="üîç Seleccionar formatos..." style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 5px;" type="text"/>
<button onclick="mostrarModalNuevoFormato('entrega')" style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); background: #3182ce; color: white; border: none; border-radius: 3px; padding: 4px 8px; font-size: 12px; cursor: pointer;" type="button">‚ûï</button>
<div class="dropdown-opciones" id="formatosEntregaFiltrados"></div>
</div>
<div class="multi-select-container" id="formatosEntregaSeleccionados" style="margin-top: 10px;">
<span style="color: #999; font-style: italic;">No hay formatos seleccionados</span>
</div>
</div>
</div>
</div>
<button class="btn" onclick="agregarProceso()">Agregar Proceso</button>
<input accept=".csv,.xlsx" id="importFile" onchange="importarDatos()" style="display: none;" type="file"/>
<button class="btn" onclick="document.getElementById('importFile').click()" style="background: #3182ce; margin-top: 5px;">üì• Importar Datos</button>
<button class="btn" onclick="exportarExcel()" style="background: #38a169; margin-top: 5px;">üìä Exportar a Excel</button>
</div>
</div>
</div>
<!-- TAB 2: CONFIGURACI√ìN -->
<div class="tab-content" id="configuracion">
<div class="dashboard">
<div class="card">
<h3>üè¢ Gesti√≥n de √Åreas</h3>
<div class="form-group">
<label>Nueva √Årea:</label>
<input id="nuevaArea" placeholder="Ej: Recursos Humanos" type="text"/>
<button class="btn" onclick="agregarArea()" style="width: auto; margin-top: 10px;">‚ûï Agregar √Årea</button>
</div>
<div id="listaAreas" style="margin-top: 15px;"></div>
</div>
<div class="card">
<h3>üë§ Gesti√≥n de Puestos</h3>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
<div class="form-group">
<label>Nuevo Puesto:</label>
<input id="nuevoPuesto" placeholder="Ej: Gerente de Ventas" type="text"/>
</div>
<div class="form-group">
<label>√Årea del Puesto:</label>
<select id="areaPuesto">
<option value="">Seleccionar √°rea...</option>
</select>
</div>
</div>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
<div class="form-group">
<label>Jefe Inmediato:</label>
<select id="jefePuesto">
<option value="">Sin jefe asignado</option>
</select>
</div>
<div class="form-group">
<label>Nivel Organizacional:</label>
<select id="nivelPuesto">
<option>Directivo</option>
<option>Gerencial</option>
<option>Supervisi√≥n</option>
<option>Operativo</option>
<option>Apoyo</option>
</select>
</div>
</div>
<button class="btn" onclick="agregarPuesto()" style="width: auto; margin-top: 10px;">‚ûï Agregar Puesto</button>
<div id="listaPuestos" style="margin-top: 15px;"></div>
</div>
<div class="card">
<h3>üíª Gesti√≥n de Sistemas</h3>
<div class="form-group">
<label>Nuevo Sistema:</label>
<input id="nuevoSistema" placeholder="Ej: Salesforce" type="text"/>
<button class="btn" onclick="agregarSistema()" style="width: auto; margin-top: 10px;">‚ûï Agregar Sistema</button>
</div>
<div id="listaSistemas" style="margin-top: 15px;"></div>
</div>
<!-- Registro de Costos de Sistemas CORREGIDO -->
<div class="card">
<h3>üí∞ Registro de Costos de Sistemas</h3>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
<div class="form-group">
<label>Sistema:</label>
<select id="sistemaCoste">
<!-- Se llenar√° din√°micamente -->
</select>
</div>
<div class="form-group">
<label>Descripci√≥n:</label>
<input id="descripcionCosto" placeholder="Ej: Software de contabilidad" type="text"/>
</div>
</div>
<div style="margin: 20px 0;">
<h4 style="color: #4a5568; margin-bottom: 15px;">Tipos de Costo</h4>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
<div style="border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px;">
<div style="margin-bottom: 10px;">
<input id="costoPorUso" style="margin-right: 8px;" type="checkbox"/>
<label for="costoPorUso" style="font-weight: 600;">Costo por Uso del Sistema</label>
</div>
<div class="form-group">
<label>Costo ($):</label>
<input disabled="" id="costoPorUsoValor" placeholder="500" type="number"/>
</div>
</div>
<div style="border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px;">
<div style="margin-bottom: 10px;">
<input id="costoPorLicencia" style="margin-right: 8px;" type="checkbox"/>
<label for="costoPorLicencia" style="font-weight: 600;">Costo por Licencias</label>
</div>
<div class="form-group">
<label>Costo por Licencia ($):</label>
<input disabled="" id="costoPorLicenciaValor" placeholder="50" type="number"/>
</div>
<div class="form-group">
<label>N√∫mero de Licencias:</label>
<input disabled="" id="numLicencias" placeholder="10" type="number"/>
</div>
</div>
</div>
</div>
<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
<div class="form-group">
<label>Forma de Pago:</label>
<select id="formaPago">
<option>Transferencia</option>
<option>Efectivo</option>
<option>Tarjeta</option>
<option>Otros</option>
</select>
</div>
<div class="form-group">
<label>Frecuencia:</label>
<select id="frecuenciaPago">
<option>Mensual</option>
<option>Anual</option>
<option>Otros</option>
</select>
</div>
<div class="form-group">
<label>Otros (especificar):</label>
<input id="otrosEspecificar" placeholder="Especificar si aplica" type="text"/>
</div>
</div>
<button class="btn" onclick="agregarCostoSistema()">üí∞ Registrar Costo</button>
<div id="listaCostosSistemas" style="margin-top: 20px;">
<!-- Se llenar√° din√°micamente -->
</div>
</div>
</div>
</div>
<!-- TAB 3: USUARIOS -->
<div class="tab-content" id="usuarios">
<div class="dashboard">
<div class="card">
<h3>üë• Gesti√≥n de Usuarios</h3>
<div style="background: #e3f2fd; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
<h4 style="color: #1976d2; margin-bottom: 10px;">üë§ Usuario Actual</h4>
<p><strong id="usuarioActualNombre">Administrador Sistema</strong></p>
<p style="color: #666; font-size: 14px;">Rol: <span id="usuarioActualRol">Administrador</span></p>
<p style="color: #666; font-size: 14px;">√öltima sesi√≥n: <span id="ultimaSesion">Ahora</span></p>
</div>
<div style="background: #f0fff4; border-radius: 8px; padding: 15px; margin-bottom: 20px; border-left: 4px solid #38a169;">
<h4 style="margin-bottom: 15px; color: #4a5568;">‚ûï Crear Nuevo Usuario</h4>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
<div class="form-group">
<label>Nombre Completo:</label>
<input id="nombreUsuario" placeholder="Ej: Juan P√©rez L√≥pez" type="text"/>
</div>
<div class="form-group">
<label>Usuario/Email:</label>
<input id="emailUsuario" placeholder="juan.perez@empresa.com" type="email"/>
</div>
</div>
<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
<div class="form-group">
<label>Rol:</label>
<select id="rolUsuario">
<option>Consulta</option>
<option>Editor</option>
<option>Administrador</option>
</select>
</div>
<div class="form-group">
<label>√Årea de Trabajo:</label>
<select id="areaUsuario">
<option value="">Todas las √°reas</option>
</select>
</div>
<div class="form-group">
<label>Estado:</label>
<select id="estadoUsuario">
<option>Activo</option>
<option>Inactivo</option>
</select>
</div>
</div>
<button onclick="crearUsuario()" style="background: #38a169; color: white; border: none; border-radius: 5px; padding: 9px 16px; cursor: pointer; font-weight: 600;">üë• Crear Usuario</button>
</div>
<div>
<h4 style="margin-bottom: 15px; color: #4a5568;">üìã Usuarios del Sistema</h4>
<div id="listaUsuarios"></div>
</div>
</div>
</div>
</div>
<!-- TAB 4: GESTI√ìN DE ACTIVIDADES -->
<div class="tab-content" id="actividades">
<div class="dashboard">
<div class="card">
<h3>üìù Gesti√≥n de Actividades</h3>
<!-- Navegaci√≥n cruzada -->
<div style="background: #e3f2fd; border-radius: 8px; padding: 10px; margin-bottom: 20px; text-align: center;">
<p style="color: #1976d2; margin: 0; font-weight: 600;">üîó Navegaci√≥n R√°pida</p>
<button onclick="mostrarSeccion('analisis')" style="background: #667eea; color: white; border: none; border-radius: 5px; padding: 8px 16px; cursor: pointer; font-weight: 600; margin-top: 5px;">üîç Ir a Matriz de An√°lisis</button>
</div>
<!-- Filtros de b√∫squeda -->
<div style="background: #f7fafc; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
<h4 style="margin-bottom: 15px; color: #4a5568;">üîç Filtros de B√∫squeda</h4>
<div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px;">
<div>
<label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Por Estado:</label>
<select id="filtroEstadoActividad" onchange="filtrarActividades()">
<option value="">Todas</option>
<option value="activa">Activas</option>
<option value="inactiva">Inactivas</option>
</select>
</div>
<div>
<label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Buscar por Nombre:</label>
<input id="filtroBuscarActividad" onkeyup="filtrarActividades()" placeholder="Buscar actividad..." style="padding: 8px; border: 1px solid #e2e8f0; border-radius: 5px; width: 100%;" type="text"/>
</div>
<div>
<label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Por Uso:</label>
<select id="filtroUsoActividad" onchange="filtrarActividades()">
<option value="">Todas</option>
<option value="usada">En uso</option>
<option value="no-usada">Sin uso</option>
</select>
</div>
<div style="display: flex; align-items: end;">
<button onclick="limpiarFiltrosActividades()" style="background: #e53e3e; color: white; border: none; border-radius: 5px; padding: 8px 16px; cursor: pointer; font-size: 12px; width: 100%;">üóëÔ∏è Limpiar</button>
</div>
</div>
</div>
<!-- Agregar nueva actividad -->
<div style="background: #f0fff4; border-radius: 8px; padding: 15px; margin-bottom: 20px; border-left: 4px solid #38a169;">
<h4 style="margin-bottom: 15px; color: #4a5568;">‚ûï Agregar Nueva Actividad</h4>
<div style="display: flex; gap: 10px; align-items: end; margin-bottom: 15px;">
<div style="flex: 1;">
<label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Nueva Actividad:</label>
<input id="nuevaActividadGestion" placeholder="Ej: Gestionar Proveedores" style="padding: 8px; border: 1px solid #e2e8f0; border-radius: 5px; width: 100%;" type="text"/>
</div>
<button onclick="agregarActividadGestion()" style="background: #38a169; color: white; border: none; border-radius: 5px; padding: 9px 16px; cursor: pointer; font-weight: 600;">‚ûï Agregar</button>
</div>
</div>
<!-- Estad√≠sticas r√°pidas -->
<div class="stats" style="margin-bottom: 20px;">
<div class="stat">
<div class="stat-number" id="totalActividades">0</div>
<div class="stat-label">Total Actividades</div>
</div>
<div class="stat">
<div class="stat-number" id="actividadesActivas">0</div>
<div class="stat-label">Activas</div>
</div>
<div class="stat">
<div class="stat-number" id="actividadesInactivas">0</div>
<div class="stat-label">Inactivas</div>
</div>
<div class="stat">
<div class="stat-number" id="actividadesEnUso">0</div>
<div class="stat-label">En Uso</div>
</div>
</div>
<!-- Lista de actividades -->
<div>
<h4 style="margin-bottom: 15px; color: #4a5568;">üìã Lista de Actividades</h4>
<div id="listaActividadesGestionCompleta"></div>
</div>
</div>
</div>
</div>
<!-- TAB 5: MATRIZ DE AN√ÅLISIS -->
<div class="tab-content" id="analisis">
<!-- Navegaci√≥n cruzada y bot√≥n actualizar an√°lisis -->
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; border-radius: 10px; padding: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
<div style="background: #e3f2fd; border-radius: 8px; padding: 10px;">
<p style="color: #1976d2; margin: 0; font-weight: 600;">üîó Navegaci√≥n R√°pida</p>
<button onclick="mostrarSeccion('actividades')" style="background: #38a169; color: white; border: none; border-radius: 5px; padding: 8px 16px; cursor: pointer; font-weight: 600; margin-top: 5px;">üìù Ir a Gesti√≥n de Actividades</button>
</div>
<div>
<button onclick="actualizarAnalisisCompleto();" style="background: #667eea; color: white; border: none; border-radius: 8px; padding: 12px 24px; cursor: pointer; font-weight: 600; font-size: 16px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">üîÑ Actualizar An√°lisis Completo</button>
</div>
</div>
<div class="matriz-container">
<h3>üìä Matriz de Actividades Transversales</h3>
<p style="margin-bottom: 15px; color: #4a5568;">
<strong>Instrucciones:</strong> Marca las casillas de las actividades que realiza cada √°rea. 
                    Las celdas rojas indican actividades duplicadas entre √°reas.
                </p>
<!-- Filtros para an√°lisis -->
<div class="filtros-analisis">
<label for="filtroAreaAnalisis">üè¢ Filtrar por √Årea:</label>
<select id="filtroAreaAnalisis" onchange="filtrarMatriz()">
<option value="">Todas las √°reas</option>
</select>
<label for="filtroActividadAnalisis">üìã Filtrar por Actividad:</label>
<select id="filtroActividadAnalisis" onchange="filtrarMatriz()">
<option value="">Todas las actividades</option>
</select>
<label for="filtroEstadoActividadAnalisis">üìä Estado Actividad:</label>
<select id="filtroEstadoActividadAnalisis" onchange="filtrarMatriz()">
<option value="">Todas</option>
<option value="activa">Solo Activas</option>
<option value="inactiva">Solo Inactivas</option>
</select>
<label for="filtroAsignacionAnalisis">üë§ Asignaci√≥n:</label>
<select id="filtroAsignacionAnalisis" onchange="filtrarDetecciones()">
<option value="">Todas</option>
<option value="asignado">Con Responsable</option>
<option value="sin-asignar">Sin Responsable</option>
</select>
<button class="btn-secundario" onclick="limpiarFiltrosAnalisis()">üîÑ Limpiar Filtros</button>
</div>
<div style="margin-bottom: 15px;">
<button class="btn" onclick="llenarMatrizAutomatica()" style="background: #3182ce; width: auto; margin-right: 10px;">ü§ñ Llenar Autom√°tico</button>
<button class="btn" onclick="analizarDuplicidades()" style="background: #38a169; width: auto;">üîç Detectar Duplicidades</button>
</div>
<table class="matriz" id="matrizActividades">
<thead>
<tr id="headerMatriz">
<th style="width: 200px;">Actividad</th>
</tr>
</thead>
<tbody id="matrizBody">
</tbody>
</table>
</div>
</div>
<!-- TAB 6: DATOS CAPTURADOS -->
<div class="tab-content" id="datos">
<div class="card">
<h3>üìä Procesos y Flujos Registrados</h3>
<!-- Filtros -->
<div style="background: #f7fafc; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
<h4 style="margin-bottom: 15px; color: #4a5568;">üîç Filtros de B√∫squeda</h4>
<div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr; gap: 15px;">
<div>
<label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Por √Årea:</label>
<select id="filtroArea" onchange="aplicarFiltros()">
<option value="">Todas las √°reas</option>
</select>
</div>
<div>
<label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Por Puesto:</label>
<select id="filtroPuesto" onchange="aplicarFiltros()">
<option value="">Todos los puestos</option>
</select>
</div>
<div>
<label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Por Estado:</label>
<select id="filtroEstado" onchange="aplicarFiltros()">
<option value="">Todos</option>
<option value="activo">Activos</option>
<option value="inactivo">Inactivos</option>
</select>
</div>
<div>
<label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Palabra Clave:</label>
<input id="filtroPalabra" onkeyup="aplicarFiltros()" placeholder="Buscar..." style="padding: 8px; border: 1px solid #e2e8f0; border-radius: 5px; width: 100%;" type="text"/>
</div>
<div style="display: flex; align-items: end;">
<button onclick="limpiarFiltros()" style="background: #e53e3e; color: white; border: none; border-radius: 5px; padding: 8px 16px; cursor: pointer; font-size: 12px; width: 100%;">üóëÔ∏è Limpiar</button>
</div>
</div>
</div>
<div style="margin-bottom: 15px;">
<button class="btn" onclick="exportarTodo()" style="background: #38a169; width: auto; display: inline-block; margin-right: 10px;">üìä Exportar Todo</button>
<button class="btn" onclick="mostrarPapelera()" style="background: #e53e3e; width: auto; display: inline-block;">üóëÔ∏è Ver Papelera</button>
</div>
<div id="listaProcesosYFlujos" style="max-height: 600px; overflow-y: auto;"></div>
</div>
</div>
<!-- TAB 7: OPORTUNIDADES/MEJORAS -->
<div class="tab-content" id="oportunidades">
<div class="dashboard">
<!-- Detecciones con asignaci√≥n de responsables -->
<div class="card">
<h3>‚ö†Ô∏è Detecciones Autom√°ticas de Procesos</h3>
<!-- Filtros para detecciones -->
<div style="background: #f7fafc; border-radius: 8px; padding: 10px; margin-bottom: 15px;">
<div style="display: flex; gap: 15px; align-items: center;">
<label style="font-weight: 600; color: #4a5568;">Filtrar detecciones autom√°ticas:</label>
<select id="filtroDeteccionesAutomaticas" onchange="filtrarDeteccionesAutomaticas()">
<option value="">Todas</option>
<option value="asignado">Con Responsable</option>
<option value="sin-asignar">Sin Responsable</option>
</select>
</div>
</div>
<div id="alertasAutomaticas"></div>
</div>
<div class="card">
<h3>üîÑ Actividades en M√∫ltiples Sistemas</h3>
<!-- Filtros para actividades en sistemas -->
<div style="background: #f7fafc; border-radius: 8px; padding: 10px; margin-bottom: 15px;">
<div style="display: flex; gap: 15px; align-items: center;">
<label style="font-weight: 600; color: #4a5568;">Filtrar actividades en sistemas:</label>
<select id="filtroActividadesSistemas" onchange="filtrarActividadesSistemas()">
<option value="">Todas</option>
<option value="asignado">Con Responsable</option>
<option value="sin-asignar">Sin Responsable</option>
</select>
</div>
</div>
<div id="actividadesSistemas"></div>
</div>
<div class="card">
<h3>üí∞ An√°lisis de Costos</h3>
<div class="stats">
<div class="stat">
<div class="stat-number" id="tiempoTotal">0</div>
<div class="stat-label">Horas/Semana en Duplicidades</div>
</div>
<div class="stat">
<div class="stat-number" id="costoEstimado">$0</div>
<div class="stat-label">Costo Mensual Estimado</div>
</div>
<div class="stat">
<div class="stat-number" id="sistemas">0</div>
<div class="stat-label">Sistemas Redundantes</div>
</div>
</div>
</div>
</div>
<div class="card">
<h3>üéØ Plan de Acci√≥n Sugerido</h3>
<div id="recomendaciones"></div>
</div>
</div>
<!-- TAB 8: ACCIONES DE MEJORA -->
<div class="tab-content" id="acciones-mejora">
<div class="dashboard">
<div class="card">
<h3>‚ö° Registro de Acciones de Mejora</h3>
<!-- Formulario de nueva acci√≥n -->
<div style="background: #f0fff4; border-radius: 8px; padding: 15px; margin-bottom: 20px; border-left: 4px solid #38a169;">
<h4 style="margin-bottom: 15px; color: #4a5568;">‚ûï Registrar Nueva Acci√≥n</h4>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
<div class="form-group">
<label>Tipo de Acci√≥n:</label>
<select id="tipoAccion">
<option>Eliminaci√≥n de Duplicidad</option>
<option>Integraci√≥n de Sistemas</option>
<option>Optimizaci√≥n de Proceso</option>
<option>Capacitaci√≥n</option>
<option>Reorganizaci√≥n</option>
<option>Automatizaci√≥n</option>
<option>Otro</option>
</select>
</div>
<div class="form-group">
<label>Estado:</label>
<select id="estadoAccion">
<option>Planificada</option>
<option>En Progreso</option>
<option>Completada</option>
<option>Cancelada</option>
</select>
</div>
</div>
<div class="form-group">
<label>Duplicidad/Problema que Aborda:</label>
<select id="duplicidadAbordada">
<option value="">No relacionado con duplicidad espec√≠fica</option>
</select>
</div>
<div class="form-group">
<label>Descripci√≥n de la Acci√≥n:</label>
<textarea id="descripcionAccion" placeholder="Describe la acci√≥n de mejora implementada..." rows="3"></textarea>
</div>
<div class="form-group">
<label>Acciones Espec√≠ficas Tomadas:</label>
<textarea id="accionesTomadas" placeholder="Detalla brevemente las acciones espec√≠ficas que se tomaron para mejorar..." rows="3"></textarea>
</div>
<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
<div class="form-group">
<label>Responsable:</label>
<input id="responsableAccion" placeholder="Nombre del responsable" type="text"/>
</div>
<div class="form-group">
<label>Fecha Objetivo:</label>
<input id="fechaObjetivo" type="date"/>
</div>
<div class="form-group">
<label>Ahorro Estimado:</label>
<div style="display: flex; gap: 5px;">
<input id="ahorroEstimado" placeholder="1000" style="flex: 1;" type="number"/>
<select id="monedaAhorro" style="width: 80px;">
<option value="MXN">MXN</option>
<option value="USD">USD</option>
<option value="EUR">EUR</option>
</select>
</div>
</div>
</div>
<button onclick="registrarAccion()" style="background: #38a169; color: white; border: none; border-radius: 5px; padding: 9px 16px; cursor: pointer; font-weight: 600;">üìù Registrar Acci√≥n</button>
</div>
<!-- Filtros para acciones -->
<div style="background: #f7fafc; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
<h4 style="margin-bottom: 15px; color: #4a5568;">üîç Filtros</h4>
<div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px;">
<div>
<label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Por Estado:</label>
<select id="filtroEstadoAcciones" onchange="filtrarAcciones()">
<option value="">Todas</option>
<option value="Planificada">Planificadas</option>
<option value="En Progreso">En Progreso</option>
<option value="Completada">Completadas</option>
<option value="Cancelada">Canceladas</option>
</select>
</div>
<div>
<label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Por Tipo:</label>
<select id="filtroTipoAcciones" onchange="filtrarAcciones()">
<option value="">Todos</option>
<option value="Eliminaci√≥n de Duplicidad">Eliminaci√≥n de Duplicidad</option>
<option value="Integraci√≥n de Sistemas">Integraci√≥n de Sistemas</option>
<option value="Optimizaci√≥n de Proceso">Optimizaci√≥n de Proceso</option>
</select>
</div>
<div>
<label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Por Responsable:</label>
<input id="filtroResponsableAcciones" onkeyup="filtrarAcciones()" placeholder="Buscar..." style="padding: 8px; border: 1px solid #e2e8f0; border-radius: 5px; width: 100%;" type="text"/>
</div>
<div style="display: flex; align-items: end;">
<button onclick="limpiarFiltrosAcciones()" style="background: #e53e3e; color: white; border: none; border-radius: 5px; padding: 8px 16px; cursor: pointer; font-size: 12px; width: 100%;">üóëÔ∏è Limpiar</button>
</div>
</div>
</div>
<div id="listaAcciones"></div>
</div>
</div>
</div>
<!-- TAB 9: AUDITOR√çA -->
<div class="tab-content" id="auditoria">
<div class="dashboard">
<div class="card">
<h3>üìù Registro de Cambios</h3>
<!-- Filtros de auditor√≠a -->
<div style="background: #f7fafc; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
<h4 style="margin-bottom: 15px; color: #4a5568;">üîç Filtros de Auditor√≠a</h4>
<div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px;">
<div>
<label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Por Tipo:</label>
<select id="filtroTipoAuditoria" onchange="filtrarAuditoria()">
<option value="">Todos</option>
<option value="proceso">Procesos</option>
<option value="actividad">Actividades</option>
<option value="sistema">Sistemas</option>
<option value="usuario">Usuarios</option>
</select>
</div>
<div>
<label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Por Usuario:</label>
<select id="filtroUsuarioAuditoria" onchange="filtrarAuditoria()">
<option value="">Todos</option>
</select>
</div>
<div>
<label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Fecha Desde:</label>
<input id="fechaDesdeAuditoria" onchange="filtrarAuditoria()" style="padding: 8px; border: 1px solid #e2e8f0; border-radius: 5px; width: 100%;" type="date"/>
</div>
<div>
<label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Fecha Hasta:</label>
<input id="fechaHastaAuditoria" onchange="filtrarAuditoria()" style="padding: 8px; border: 1px solid #e2e8f0; border-radius: 5px; width: 100%;" type="date"/>
</div>
</div>
</div>
<!-- Estad√≠sticas de auditor√≠a -->
<div class="stats" style="margin-bottom: 20px;">
<div class="stat">
<div class="stat-number" id="totalCambios">0</div>
<div class="stat-label">Total Cambios</div>
</div>
<div class="stat">
<div class="stat-number" id="cambiosHoy">0</div>
<div class="stat-label">Cambios Hoy</div>
</div>
<div class="stat">
<div class="stat-number" id="usuariosActivos">0</div>
<div class="stat-label">Usuarios Activos</div>
</div>
</div>
<!-- Lista de cambios -->
<div>
<h4 style="margin-bottom: 15px; color: #4a5568;">üìã Historial de Cambios</h4>
<div id="listaAuditoria" style="max-height: 500px; overflow-y: auto;"></div>
</div>
</div>
</div>
</div>
<!-- TAB 10: DASHBOARD -->
<div class="tab-content" id="dashboard">
<div class="dashboard">
<div class="card">
<h3>üìà Resumen Ejecutivo</h3>
<div class="stats">
<div class="stat">
<div class="stat-number" id="totalProcesos">0</div>
<div class="stat-label">Procesos Mapeados</div>
</div>
<div class="stat">
<div class="stat-number" id="duplicidadesEncontradas">0</div>
<div class="stat-label">Duplicidades Detectadas</div>
</div>
<div class="stat">
<div class="stat-number" id="ahorrosPotenciales">0%</div>
<div class="stat-label">Ahorro Potencial</div>
</div>
<div class="stat">
<div class="stat-number" id="accionesCompletadas">0</div>
<div class="stat-label">Acciones Completadas</div>
</div>
</div>
</div>
<div class="card">
<h3>üí∞ Costos de Sistemas</h3>
<div class="stats">
<div class="stat">
<div class="stat-number" id="costoTotalSistemas">$0</div>
<div class="stat-label">Costo Total Mensual</div>
</div>
<div class="stat">
<div class="stat-number" id="totalLicencias">0</div>
<div class="stat-label">Total Licencias</div>
</div>
<div class="stat">
<div class="stat-number" id="costoPorUsuario">$0</div>
<div class="stat-label">Costo por Usuario</div>
</div>
<div class="stat">
<div class="stat-number" id="ahorroAcumulado">$0</div>
<div class="stat-label">Ahorro Acumulado</div>
</div>
</div>
</div>
</div>
</div>
</div>
<script>
        // Variables globales
        let procesos = [];
        let flujos = [];
        let papelera = { procesos: [], flujos: [] };
        let areas = ['Administraci√≥n', 'Marketing', 'Comercial', 'Operaciones', 'Importaciones', 'Inventarios'];
        let puestos = [
            { nombre: 'Gerente', area: 'Administraci√≥n', jefe: '', nivel: 'Gerencial' },
            { nombre: 'Analista', area: 'Administraci√≥n', jefe: 'Gerente', nivel: 'Operativo' },
            { nombre: 'Coordinador', area: 'Marketing', jefe: 'Gerente', nivel: 'Supervisi√≥n' },
            { nombre: 'Asistente', area: 'Administraci√≥n', jefe: 'Analista', nivel: 'Apoyo' },
            { nombre: 'Director', area: '', jefe: '', nivel: 'Directivo' },
            { nombre: 'Supervisor', area: 'Operaciones', jefe: 'Gerente', nivel: 'Supervisi√≥n' }
        ];
        let sistemas = ['SAP', 'Excel', 'CRM', 'ERP', 'Email', 'WhatsApp'];
        let costosSistemas = [];
        let actividades = [
            'Validar Cliente', 'Generar Factura', 'Actualizar Inventario', 
            'Procesar Pago', 'Enviar Email', 'Crear Reporte', 
            'Verificar Datos', 'Aprobar Documento', 'Registrar Movimiento',
            'Importar Productos', 'Gestionar Inventario', 'Procesar Orden',
            'Contactar Proveedor', 'Revisar Calidad', 'Calcular Costos'
        ];
        let actividadesInactivas = [];
        let actividadesSeleccionadasTemp = [];
        let sistemasSeleccionadosTemp = [];
        
        // Variables para informaci√≥n de flujo
        let fuentesInfoRecibe = ['Clientes', 'Proveedores', 'CEDIS', '√Årea Comercial', '√Årea Administrativa', 'Sistemas Externos'];
        let destinosInfoEntrega = ['Clientes', 'Proveedores', 'CEDIS', '√Årea Comercial', '√Årea Administrativa', 'Sistemas Externos', 'Reportes Gerenciales'];
        let formatosDisponibles = ['Excel', 'Email', 'Sistema', 'Papel', 'PDF', 'Digital', 'WhatsApp', 'Telef√≥nico'];
        let fuentesInfoRecibeSeleccionadas = [];
        let destinosInfoEntregaSeleccionados = [];
        let formatosRecibeSeleccionados = [];
        let formatosEntregaSeleccionados = [];
        
        let usuarios = [
            { id: 1, nombre: 'Administrador Sistema', email: 'admin@empresa.com', rol: 'Administrador', area: '', estado: 'Activo', fechaCreacion: new Date().toISOString(), ultimaSesion: new Date().toISOString() }
        ];
        let usuarioActual = usuarios[0];
        let accionesMejora = [];
        let auditoria = [];
        let deteccionesConResponsable = new Map();
        let duplicidadesDetectadas = [];

        // Funci√≥n principal para mostrar secciones
        function mostrarSeccion(seccionName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(seccionName).classList.add('active');
            event.target.classList.add('active');
            
            // Inicializar secci√≥n espec√≠fica
            if (seccionName === 'captura') {
                inicializarCaptura();
            } else if (seccionName === 'configuracion') {
                mostrarConfiguracionCompleta();
            } else if (seccionName === 'usuarios') {
                mostrarGestionUsuarios();
            } else if (seccionName === 'actividades') {
                mostrarGestionActividades();
            } else if (seccionName === 'analisis') {
                crearMatriz();
                actualizarFiltrosAnalisis();
            } else if (seccionName === 'datos') {
                mostrarVistaProcesosYFlujos();
            } else if (seccionName === 'oportunidades') {
                generarDeteccionesAutomaticas();
            } else if (seccionName === 'acciones-mejora') {
                mostrarAccionesMejora();
                actualizarDuplicidadesEnSelect();
            } else if (seccionName === 'auditoria') {
                mostrarAuditoria();
            } else if (seccionName === 'dashboard') {
                actualizarDashboard();
            }
        }

        // Funci√≥n para inicializar captura
        function inicializarCaptura() {
            validarActividadesDisponibles();
            inicializarSistemasMultiples();
            inicializarInfoRecibe();
            inicializarInfoEntrega();
            inicializarFormatosMultiples();
        }

        // Funci√≥n para validar actividades disponibles
        function validarActividadesDisponibles() {
    return true;

            const contenedor = document.getElementById('contenedorActividades');
            
            if (actividades.length === 0) {
                contenedor.innerHTML = `
                    <div style="border: 2px solid #fed7d7; border-radius: 8px; padding: 15px; background: #fef5e7; text-align: center;">
                        <p style="color: #c53030; margin: 0; font-weight: 600;">‚ö†Ô∏è No hay actividades registradas</p>
                        <p style="color: #c53030; margin: 5px 0 10px 0; font-size: 14px;">Debe agregar actividades en el m√≥dulo de Gesti√≥n de Actividades antes de continuar.</p>
                        <button onclick="mostrarSeccion('actividades')" style="background: #38a169; color: white; border: none; border-radius: 5px; padding: 8px 16px; cursor: pointer; font-weight: 600;">üìù Ir a Gesti√≥n de Actividades</button>
                    </div>
                `;
            } else {
                contenedor.innerHTML = `
                    <div style="border: 2px solid #e2e8f0; border-radius: 8px; padding: 10px; background: #f9f9f9;">
                        <div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
                            <div style="flex: 1; position: relative;">
                                <input type="text" id="filtroActividades" placeholder="üîç Buscar y seleccionar actividades..." style="width: 100%; padding: 6px; border: 1px solid #e2e8f0; border-radius: 5px;">
                                <div id="actividadesFiltradas" class="dropdown-opciones"></div>
                            </div>
                            <button type="button" onclick="mostrarModalNuevaActividad()" style="background: #38a169; color: white; border: none; border-radius: 5px; padding: 6px 12px; cursor: pointer; font-size: 12px;">‚ûï Nueva</button>
                            <button type="button" onclick="limpiarActividadesSeleccionadas()" style="background: #e53e3e; color: white; border: none; border-radius: 5px; padding: 6px 12px; cursor: pointer; font-size: 12px;">üóëÔ∏è Limpiar</button>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <strong style="color: #4a5568; font-size: 14px;">Actividades Seleccionadas:</strong>
                        </div>
                        <div id="actividadesSeleccionadas" style="min-height: 60px; border: 1px solid #e2e8f0; border-radius: 5px; padding: 8px; background: white;">
                            <span style="color: #999; font-style: italic;">No hay actividades seleccionadas</span>
                        </div>
                    </div>
                `;
                inicializarFiltroActividades();
            }
        }

        // CORRECCI√ìN: Funci√≥n para limpiar actividades manualmente
        function limpiarActividadesSeleccionadas() {
            actividadesSeleccionadasTemp = [];
            actualizarVistaActividadesSeleccionadas();
            mostrarAlerta('‚úÖ Actividades limpiadas', 'success');
        }

        // Funci√≥n para inicializar filtro de actividades
        function inicializarFiltroActividades() {
            const filtroInput = document.getElementById('filtroActividades');
            const contenedorFiltradas = document.getElementById('actividadesFiltradas');
            
            if (!filtroInput || !contenedorFiltradas) return;
            
            filtroInput.addEventListener('input', function() {
                const filtro = this.value.toLowerCase().trim();
                
                if (filtro.length === 0) {
                    contenedorFiltradas.style.display = 'none';
                    return;
                }
                
                const actividadesFiltradas = actividades.filter(actividad => 
                    actividad.toLowerCase().includes(filtro) && 
                    !actividadesSeleccionadasTemp.includes(actividad)
                );
                
                if (actividadesFiltradas.length > 0) {
                    let html = '';
                    actividadesFiltradas.slice(0, 10).forEach(actividad => {
                        html += `<div class="opcion-item" onclick="seleccionarActividadFiltrada('${actividad}')">${actividad}</div>`;
                    });
                    contenedorFiltradas.innerHTML = html;
                    contenedorFiltradas.style.display = 'block';
                } else {
                    contenedorFiltradas.innerHTML = '<div class="opcion-item" style="color: #999; cursor: default;">No se encontraron actividades</div>';
                    contenedorFiltradas.style.display = 'block';
                }
            });
            
            document.addEventListener('click', function(e) {
                if (!filtroInput.contains(e.target) && !contenedorFiltradas.contains(e.target)) {
                    contenedorFiltradas.style.display = 'none';
                }
            });
        }

        function seleccionarActividadFiltrada(actividad) {
            if (!actividadesSeleccionadasTemp.includes(actividad)) {
                actividadesSeleccionadasTemp.push(actividad);
                actualizarVistaActividadesSeleccionadas();
            }
            
            document.getElementById('filtroActividades').value = '';
            document.getElementById('actividadesFiltradas').style.display = 'none';
        }

        function actualizarVistaActividadesSeleccionadas() {
            const container = document.getElementById('actividadesSeleccionadas');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (actividadesSeleccionadasTemp.length === 0) {
                container.innerHTML = '<span style="color: #999; font-style: italic;">No hay actividades seleccionadas</span>';
            } else {
                actividadesSeleccionadasTemp.forEach(actividad => {
                    const chip = document.createElement('span');
                    chip.className = 'multi-select-item';
                    chip.innerHTML = `${actividad} <span class="remove" onclick="eliminarActividadSeleccionada('${actividad}')">√ó</span>`;
                    container.appendChild(chip);
                });
            }
        }

        function eliminarActividadSeleccionada(actividad) {
            actividadesSeleccionadasTemp = actividadesSeleccionadasTemp.filter(a => a !== actividad);
            actualizarVistaActividadesSeleccionadas();
        }

        // Funciones para sistemas m√∫ltiples
        function inicializarSistemasMultiples() {
            const filtroSistemas = document.getElementById('filtroSistemas');
            const sistemasFiltrados = document.getElementById('sistemasFiltrados');
            
            if (!filtroSistemas || !sistemasFiltrados) return;
            
            filtroSistemas.addEventListener('input', function() {
                const filtro = this.value.toLowerCase().trim();
                
                if (filtro.length === 0) {
                    sistemasFiltrados.style.display = 'none';
                    return;
                }
                
                const sistemasFilt = sistemas.filter(sistema => 
                    sistema.toLowerCase().includes(filtro) && 
                    !sistemasSeleccionadosTemp.includes(sistema)
                );
                
                if (sistemasFilt.length > 0) {
                    let html = '';
                    sistemasFilt.slice(0, 10).forEach(sistema => {
                        html += `<div class="opcion-item" onclick="seleccionarSistema('${sistema}')">${sistema}</div>`;
                    });
                    sistemasFiltrados.innerHTML = html;
                    sistemasFiltrados.style.display = 'block';
                } else {
                    sistemasFiltrados.innerHTML = '<div class="opcion-item" style="color: #999; cursor: default;">No se encontraron sistemas</div>';
                    sistemasFiltrados.style.display = 'block';
                }
            });
            
            document.addEventListener('click', function(e) {
                if (!filtroSistemas.contains(e.target) && !sistemasFiltrados.contains(e.target)) {
                    sistemasFiltrados.style.display = 'none';
                }
            });
        }

        function seleccionarSistema(sistema) {
            if (!sistemasSeleccionadosTemp.includes(sistema)) {
                sistemasSeleccionadosTemp.push(sistema);
                actualizarVistaSistemasSeleccionados();
            }
            
            document.getElementById('filtroSistemas').value = '';
            document.getElementById('sistemasFiltrados').style.display = 'none';
        }

        function actualizarVistaSistemasSeleccionados() {
            const container = document.getElementById('sistemasSeleccionados');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (sistemasSeleccionadosTemp.length === 0) {
                container.innerHTML = '<span style="color: #999; font-style: italic;">No hay sistemas seleccionados</span>';
            } else {
                sistemasSeleccionadosTemp.forEach(sistema => {
                    const item = document.createElement('span');
                    item.className = 'multi-select-item';
                    item.innerHTML = `${sistema} <span class="remove" onclick="eliminarSistemaSeleccionado('${sistema}')">√ó</span>`;
                    container.appendChild(item);
                });
            }
        }

        function eliminarSistemaSeleccionado(sistema) {
            sistemasSeleccionadosTemp = sistemasSeleccionadosTemp.filter(s => s !== sistema);
            actualizarVistaSistemasSeleccionados();
        }

        // Funciones para informaci√≥n de flujo
        function inicializarInfoRecibe() {
            const filtroInfoRecibe = document.getElementById('filtroInfoRecibe');
            const fuentesFiltradas = document.getElementById('fuentesInfoRecibeFiltradas');
            
            if (!filtroInfoRecibe || !fuentesFiltradas) return;
            
            filtroInfoRecibe.addEventListener('input', function() {
                const filtro = this.value.toLowerCase().trim();
                
                if (filtro.length === 0) {
                    fuentesFiltradas.style.display = 'none';
                    return;
                }
                
                const fuentesFilt = fuentesInfoRecibe.filter(fuente => 
                    fuente.toLowerCase().includes(filtro) && 
                    !fuentesInfoRecibeSeleccionadas.includes(fuente)
                );
                
                if (fuentesFilt.length > 0) {
                    let html = '';
                    fuentesFilt.forEach(fuente => {
                        html += `<div class="opcion-item" onclick="seleccionarFuenteRecibe('${fuente}')">${fuente}</div>`;
                    });
                    fuentesFiltradas.innerHTML = html;
                    fuentesFiltradas.style.display = 'block';
                } else {
                    fuentesFiltradas.innerHTML = '<div class="opcion-item" style="color: #999; cursor: default;">No se encontraron fuentes</div>';
                    fuentesFiltradas.style.display = 'block';
                }
            });
        }

        function inicializarInfoEntrega() {
            const filtroInfoEntrega = document.getElementById('filtroInfoEntrega');
            const destinosFiltrados = document.getElementById('destinosInfoEntregaFiltrados');
            
            if (!filtroInfoEntrega || !destinosFiltrados) return;
            
            filtroInfoEntrega.addEventListener('input', function() {
                const filtro = this.value.toLowerCase().trim();
                
                if (filtro.length === 0) {
                    destinosFiltrados.style.display = 'none';
                    return;
                }
                
                const destinosFilt = destinosInfoEntrega.filter(destino => 
                    destino.toLowerCase().includes(filtro) && 
                    !destinosInfoEntregaSeleccionados.includes(destino)
                );
                
                if (destinosFilt.length > 0) {
                    let html = '';
                    destinosFilt.forEach(destino => {
                        html += `<div class="opcion-item" onclick="seleccionarDestinoEntrega('${destino}')">${destino}</div>`;
                    });
                    destinosFiltrados.innerHTML = html;
                    destinosFiltrados.style.display = 'block';
                } else {
                    destinosFiltrados.innerHTML = '<div class="opcion-item" style="color: #999; cursor: default;">No se encontraron destinos</div>';
                    destinosFiltrados.style.display = 'block';
                }
            });
        }

        function seleccionarFuenteRecibe(fuente) {
            if (!fuentesInfoRecibeSeleccionadas.includes(fuente)) {
                fuentesInfoRecibeSeleccionadas.push(fuente);
                actualizarVistaFuentesRecibeSeleccionadas();
            }
            
            document.getElementById('filtroInfoRecibe').value = '';
            document.getElementById('fuentesInfoRecibeFiltradas').style.display = 'none';
        }

        function seleccionarDestinoEntrega(destino) {
            if (!destinosInfoEntregaSeleccionados.includes(destino)) {
                destinosInfoEntregaSeleccionados.push(destino);
                actualizarVistaDestinosEntregaSeleccionados();
            }
            
            document.getElementById('filtroInfoEntrega').value = '';
            document.getElementById('destinosInfoEntregaFiltrados').style.display = 'none';
        }

        function actualizarVistaFuentesRecibeSeleccionadas() {
            const container = document.getElementById('fuentesInfoRecibeSeleccionadas');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (fuentesInfoRecibeSeleccionadas.length === 0) {
                container.innerHTML = '<span style="color: #999; font-style: italic;">No hay fuentes seleccionadas</span>';
            } else {
                fuentesInfoRecibeSeleccionadas.forEach(fuente => {
                    const item = document.createElement('span');
                    item.className = 'multi-select-item';
                    item.innerHTML = `${fuente} <span class="remove" onclick="eliminarFuenteRecibe('${fuente}')">√ó</span>`;
                    container.appendChild(item);
                });
            }
        }

        function actualizarVistaDestinosEntregaSeleccionados() {
            const container = document.getElementById('destinosInfoEntregaSeleccionados');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (destinosInfoEntregaSeleccionados.length === 0) {
                container.innerHTML = '<span style="color: #999; font-style: italic;">No hay destinos seleccionados</span>';
            } else {
                destinosInfoEntregaSeleccionados.forEach(destino => {
                    const item = document.createElement('span');
                    item.className = 'multi-select-item';
                    item.innerHTML = `${destino} <span class="remove" onclick="eliminarDestinoEntrega('${destino}')">√ó</span>`;
                    container.appendChild(item);
                });
            }
        }

        function eliminarFuenteRecibe(fuente) {
            fuentesInfoRecibeSeleccionadas = fuentesInfoRecibeSeleccionadas.filter(f => f !== fuente);
            actualizarVistaFuentesRecibeSeleccionadas();
        }

        function eliminarDestinoEntrega(destino) {
            destinosInfoEntregaSeleccionados = destinosInfoEntregaSeleccionados.filter(d => d !== destino);
            actualizarVistaDestinosEntregaSeleccionados();
        }

        // Funciones para formatos m√∫ltiples
        function inicializarFormatosMultiples() {
            const filtroFormatoRecibe = document.getElementById('filtroFormatoRecibe');
            const formatosRecibeFiltrados = document.getElementById('formatosRecibeFiltrados');
            
            if (filtroFormatoRecibe && formatosRecibeFiltrados) {
                filtroFormatoRecibe.addEventListener('input', function() {
                    const filtro = this.value.toLowerCase().trim();
                    
                    if (filtro.length === 0) {
                        formatosRecibeFiltrados.style.display = 'none';
                        return;
                    }
                    
                    const formatosFilt = formatosDisponibles.filter(formato => 
                        formato.toLowerCase().includes(filtro) && 
                        !formatosRecibeSeleccionados.includes(formato)
                    );
                    
                    if (formatosFilt.length > 0) {
                        let html = '';
                        formatosFilt.forEach(formato => {
                            html += `<div class="opcion-item" onclick="seleccionarFormatoRecibe('${formato}')">${formato}</div>`;
                        });
                        formatosRecibeFiltrados.innerHTML = html;
                        formatosRecibeFiltrados.style.display = 'block';
                    } else {
                        formatosRecibeFiltrados.innerHTML = '<div class="opcion-item" style="color: #999; cursor: default;">No se encontraron formatos</div>';
                        formatosRecibeFiltrados.style.display = 'block';
                    }
                });
            }

            const filtroFormatoEntrega = document.getElementById('filtroFormatoEntrega');
            const formatosEntregaFiltrados = document.getElementById('formatosEntregaFiltrados');
            
            if (filtroFormatoEntrega && formatosEntregaFiltrados) {
                filtroFormatoEntrega.addEventListener('input', function() {
                    const filtro = this.value.toLowerCase().trim();
                    
                    if (filtro.length === 0) {
                        formatosEntregaFiltrados.style.display = 'none';
                        return;
                    }
                    
                    const formatosFilt = formatosDisponibles.filter(formato => 
                        formato.toLowerCase().includes(filtro) && 
                        !formatosEntregaSeleccionados.includes(formato)
                    );
                    
                    if (formatosFilt.length > 0) {
                        let html = '';
                        formatosFilt.forEach(formato => {
                            html += `<div class="opcion-item" onclick="seleccionarFormatoEntrega('${formato}')">${formato}</div>`;
                        });
                        formatosEntregaFiltrados.innerHTML = html;
                        formatosEntregaFiltrados.style.display = 'block';
                    } else {
                        formatosEntregaFiltrados.innerHTML = '<div class="opcion-item" style="color: #999; cursor: default;">No se encontraron formatos</div>';
                        formatosEntregaFiltrados.style.display = 'block';
                    }
                });
            }
        }

        function seleccionarFormatoRecibe(formato) {
            if (!formatosRecibeSeleccionados.includes(formato)) {
                formatosRecibeSeleccionados.push(formato);
                actualizarVistaFormatosRecibeSeleccionados();
            }
            
            document.getElementById('filtroFormatoRecibe').value = '';
            document.getElementById('formatosRecibeFiltrados').style.display = 'none';
        }

        function seleccionarFormatoEntrega(formato) {
            if (!formatosEntregaSeleccionados.includes(formato)) {
                formatosEntregaSeleccionados.push(formato);
                actualizarVistaFormatosEntregaSeleccionados();
            }
            
            document.getElementById('filtroFormatoEntrega').value = '';
            document.getElementById('formatosEntregaFiltrados').style.display = 'none';
        }

        function actualizarVistaFormatosRecibeSeleccionados() {
            const container = document.getElementById('formatosRecibeSeleccionados');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (formatosRecibeSeleccionados.length === 0) {
                container.innerHTML = '<span style="color: #999; font-style: italic;">No hay formatos seleccionados</span>';
            } else {
                formatosRecibeSeleccionados.forEach(formato => {
                    const item = document.createElement('span');
                    item.className = 'multi-select-item';
                    item.innerHTML = `${formato} <span class="remove" onclick="eliminarFormatoRecibe('${formato}')">√ó</span>`;
                    container.appendChild(item);
                });
            }
        }

        function actualizarVistaFormatosEntregaSeleccionados() {
            const container = document.getElementById('formatosEntregaSeleccionados');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (formatosEntregaSeleccionados.length === 0) {
                container.innerHTML = '<span style="color: #999; font-style: italic;">No hay formatos seleccionados</span>';
            } else {
                formatosEntregaSeleccionados.forEach(formato => {
                    const item = document.createElement('span');
                    item.className = 'multi-select-item';
                    item.innerHTML = `${formato} <span class="remove" onclick="eliminarFormatoEntrega('${formato}')">√ó</span>`;
                    container.appendChild(item);
                });
            }
        }

        function eliminarFormatoRecibe(formato) {
            formatosRecibeSeleccionados = formatosRecibeSeleccionados.filter(f => f !== formato);
            actualizarVistaFormatosRecibeSeleccionados();
        }

        function eliminarFormatoEntrega(formato) {
            formatosEntregaSeleccionados = formatosEntregaSeleccionados.filter(f => f !== formato);
            actualizarVistaFormatosEntregaSeleccionados();
        }

        // CORRECCI√ìN: Funci√≥n para agregar proceso que NO borra las actividades
        function agregarProceso() {
            if (!validarActividadesDisponibles()) {
                mostrarAlerta('‚ùå Debe agregar actividades antes de crear un proceso', 'alert');
                return;
            }

            const area = document.getElementById('area').value;
            const puesto = document.getElementById('puesto').value;
            const proceso = document.getElementById('proceso').value;
            const descripcion = document.getElementById('descripcion').value;
            const tiempo = parseInt(document.getElementById('tiempo').value) || 0;
            const frecuencia = document.getElementById('frecuencia').value;
            
            const descripcionInfoRecibe = document.getElementById('descripcionInfoRecibe').value;
            const descripcionInfoEntrega = document.getElementById('descripcionInfoEntrega').value;

            if (proceso.trim() && area && puesto && frecuencia) {
                const ahora = new Date().toISOString();
                const nuevoProceso = {
                    area, puesto, 
                    descripcion: proceso,
                    proceso, 
                    sistemas: sistemasSeleccionadosTemp.length > 0 ? [...sistemasSeleccionadosTemp] : [],
                    tiempo, frecuencia,
                    actividades: [...actividadesSeleccionadasTemp], // L√çNEA CLAVE - Copiar array
                    activo: true,
                    id: Date.now(),
                    fechaCreacion: ahora,
                    usuarioCreacion: usuarioActual.nombre,
                    fechaModificacion: ahora,
                    usuarioModificacion: usuarioActual.nombre,
                    flujoInfo: {
                        fuentesRecibe: [...fuentesInfoRecibeSeleccionadas],
                        destinosEntrega: [...destinosInfoEntregaSeleccionados],
                        descripcionRecibe: descripcionInfoRecibe,
                        descripcionEntrega: descripcionInfoEntrega,
                        formatosRecibe: [...formatosRecibeSeleccionados],
                        formatosEntrega: [...formatosEntregaSeleccionados]
                    }
                };
                
                procesos.push(nuevoProceso);

                // Si hay informaci√≥n de flujo, crear flujo asociado
                if (descripcionInfoRecibe.trim() || descripcionInfoEntrega.trim()) {
                    flujos.push({
                        procesoRelacionado: `${area} - ${proceso}`,
                        input: descripcionInfoRecibe,
                        output: descripcionInfoEntrega,
                        formato: 'M√∫ltiple',
                        id: Date.now() + 1,
                        fechaCreacion: ahora,
                        usuarioCreacion: usuarioActual.nombre
                    });
                }

                registrarCambio('proceso', 'crear', `Nuevo proceso creado: ${area} - ${proceso}`, null, nuevoProceso);

                // Actualizar matriz autom√°ticamente
                if (actividadesSeleccionadasTemp.length > 0) {
                    setTimeout(() => {
                        actividadesSeleccionadasTemp.forEach(actividad => {
                            const checkbox = document.querySelector(`input[data-area="${area}"][data-actividad="${actividad}"]`);
                            if (checkbox) checkbox.checked = true;
                        });
                        verificarDuplicidadesEnMatriz();
                    }, 100);
                }

                // Limpiar formulario PERO MANTENER LAS ACTIVIDADES
                limpiarFormularioProceso();
                actualizarDashboard();
                mostrarVistaProcesosYFlujos();
                generarDeteccionesAutomaticas();
                mostrarAlerta('‚úÖ Proceso agregado correctamente. Las actividades se mantienen para el siguiente registro.', 'success');
            } else {
                mostrarAlerta('‚ùå Complete todos los campos requeridos (Proceso, √Årea, Puesto, Frecuencia)', 'alert');
            }
        }

        // CORRECCI√ìN: Funci√≥n de importaci√≥n de datos
        function importarDatos() {
            const file = document.getElementById('importFile').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const csv = e.target.result;
                    const lines = csv.split('\n');
                    let importados = 0;
                    
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (line) {
                            const columns = line.split(',');
                            if (columns.length >= 5) {
                                const area = columns[0].replace(/"/g, '');
                                const puesto = columns[1] ? columns[1].replace(/"/g, '') : '';
                                const proceso = columns[2] ? columns[2].replace(/"/g, '') : columns[1].replace(/"/g, '');
                                const sistemas = columns[3] ? columns[3].replace(/"/g, '') : '';
                                const tiempo = parseInt(columns[4]) || 0;
                                const frecuencia = columns[5] ? columns[5].replace(/"/g, '') : 'Por demanda';
                                
                                const ahora = new Date().toISOString();
                                procesos.push({
                                    area: area,
                                    puesto: puesto,
                                    descripcion: proceso,
                                    proceso, 
                                    sistemas: sistemas ? [sistemas] : [],
                                    tiempo: tiempo,
                                    frecuencia: frecuencia,
                                    activo: true,
                                    actividades: [],
                                    id: Date.now() + i,
                                    fechaCreacion: ahora,
                                    usuarioCreacion: 'Importaci√≥n',
                                    fechaModificacion: ahora,
                                    usuarioModificacion: usuarioActual.nombre
                                });
                                importados++;
                            }
                        }
                    }
                    
                    registrarCambio('proceso', 'crear', `Importaci√≥n masiva: ${importados} procesos importados`, null, { cantidad: importados });
                    
                    actualizarDashboard();
                    mostrarVistaProcesosYFlujos();
                    generarDeteccionesAutomaticas();
                    mostrarAlerta(`‚úÖ ${importados} procesos importados correctamente`, 'success');
                };
                reader.readAsText(file);
            }
        }

        // Funci√≥n para limpiar formulario SIN borrar actividades seleccionadas
        function limpiarFormularioProceso() {
            document.getElementById('proceso').value = '';
            document.getElementById('descripcion').value = '';
            document.getElementById('tiempo').value = '';
            
            document.getElementById('area').selectedIndex = 0;
            document.getElementById('puesto').selectedIndex = 0;
            document.getElementById('frecuencia').selectedIndex = 0;
            
            sistemasSeleccionadosTemp = [];
            actualizarVistaSistemasSeleccionados();
            document.getElementById('filtroSistemas').value = '';
            
            // NO limpiar actividadesSeleccionadasTemp aqu√≠
            // Las actividades se mantienen para el siguiente proceso
            
            fuentesInfoRecibeSeleccionadas = [];
            destinosInfoEntregaSeleccionados = [];
            formatosRecibeSeleccionados = [];
            formatosEntregaSeleccionados = [];
            
            actualizarVistaFuentesRecibeSeleccionadas();
            actualizarVistaDestinosEntregaSeleccionados();
            actualizarVistaFormatosRecibeSeleccionados();
            actualizarVistaFormatosEntregaSeleccionados();
            
            document.getElementById('filtroInfoRecibe').value = '';
            document.getElementById('filtroInfoEntrega').value = '';
            document.getElementById('filtroFormatoRecibe').value = '';
            document.getElementById('filtroFormatoEntrega').value = '';
            document.getElementById('descripcionInfoRecibe').value = '';
            document.getElementById('descripcionInfoEntrega').value = '';
        }

        // Funciones de configuraci√≥n
        function mostrarConfiguracionCompleta() {
            actualizarListaAreas();
            actualizarListaPuestos();
            actualizarListaSistemas();
            actualizarListaCostosSistemas();
            actualizarSelectsConfiguracion();
        }

        function actualizarSelectsConfiguracion() {
            actualizarSelectAreas();
            actualizarSelectPuestos();
            actualizarSistemasCostos();
            actualizarSelectsPuestos();
        }

        function actualizarSelectAreas() {
            const select = document.getElementById('area');
            if (select) {
                select.innerHTML = '<option value="">Seleccionar √°rea...</option>';
                areas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area;
                    option.textContent = area;
                    select.appendChild(option);
                });
            }
        }

        function actualizarSelectPuestos() {
            const select = document.getElementById('puesto');
            if (select) {
                select.innerHTML = '<option value="">Seleccionar puesto...</option>';
                puestos.forEach(puesto => {
                    const option = document.createElement('option');
                    option.value = puesto.nombre;
                    option.textContent = `${puesto.nombre}${puesto.area ? ` (${puesto.area})` : ''}`;
                    select.appendChild(option);
                });
            }
        }

        function actualizarSelectsPuestos() {
            const areaPuestoSelect = document.getElementById('areaPuesto');
            if (areaPuestoSelect) {
                areaPuestoSelect.innerHTML = '<option value="">Seleccionar √°rea...</option>';
                areas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area;
                    option.textContent = area;
                    areaPuestoSelect.appendChild(option);
                });
            }
            
            const jefePuestoSelect = document.getElementById('jefePuesto');
            if (jefePuestoSelect) {
                jefePuestoSelect.innerHTML = '<option value="">Sin jefe asignado</option>';
                puestos.forEach(puesto => {
                    const option = document.createElement('option');
                    option.value = puesto.nombre;
                    option.textContent = `${puesto.nombre}${puesto.area ? ` (${puesto.area})` : ''}`;
                    jefePuestoSelect.appendChild(option);
                });
            }
        }

        function actualizarSistemasCostos() {
            const sistemaCosteSelect = document.getElementById('sistemaCoste');
            if (sistemaCosteSelect) {
                sistemaCosteSelect.innerHTML = '<option value="">Seleccionar sistema...</option>';
                sistemas.forEach(sistema => {
                    const option = document.createElement('option');
                    option.value = sistema;
                    option.textContent = sistema;
                    sistemaCosteSelect.appendChild(option);
                });
            }
        }

        function agregarArea() {
            const nuevaArea = document.getElementById('nuevaArea').value.trim();
            if (nuevaArea && !areas.includes(nuevaArea)) {
                areas.push(nuevaArea);
                registrarCambio('sistema', 'crear', `Nueva √°rea creada: ${nuevaArea}`, null, { nombre: nuevaArea });
                actualizarSelectsConfiguracion();
                crearMatriz();
                actualizarFiltrosAnalisis();
                document.getElementById('nuevaArea').value = '';
                actualizarListaAreas();
                mostrarAlerta('‚úÖ √Årea agregada correctamente', 'success');
            } else if (areas.includes(nuevaArea)) {
                mostrarAlerta('‚ùå Esta √°rea ya existe', 'alert');
            } else {
                mostrarAlerta('‚ùå Ingresa un nombre para el √°rea', 'alert');
            }
        }

        // CORRECCI√ìN: Funci√≥n para editar √°rea
        function editarArea(areaAntigua) {
            const areaNueva = prompt('Nuevo nombre para el √°rea:', areaAntigua);
            if (areaNueva && areaNueva.trim() && areaNueva.trim() !== areaAntigua) {
                const index = areas.indexOf(areaAntigua);
                if (index !== -1) {
                    areas[index] = areaNueva.trim();
                    
                    // Actualizar en procesos
                    procesos.forEach(proceso => {
                        if (proceso.area === areaAntigua) {
                            proceso.area = areaNueva.trim();
                        }
                    });
                    
                    // Actualizar en puestos
                    puestos.forEach(puesto => {
                        if (puesto.area === areaAntigua) {
                            puesto.area = areaNueva.trim();
                        }
                    });
                    
                    registrarCambio('sistema', 'modificar', `√Årea modificada: ${areaAntigua} ‚Üí ${areaNueva.trim()}`, 
                        { nombre: areaAntigua }, { nombre: areaNueva.trim() });
                    
                    actualizarSelectsConfiguracion();
                    crearMatriz();
                    actualizarFiltrosAnalisis();
                    actualizarListaAreas();
                    mostrarAlerta('‚úÖ √Årea actualizada correctamente', 'success');
                }
            }
        }

        function eliminarArea(area) {
            const index = areas.indexOf(area);
            if (index >= 6) { // Solo eliminar √°reas no predefinidas
                if (confirm(`¬øEliminar el √°rea "${area}"?`)) {
                    areas.splice(index, 1);
                    registrarCambio('sistema', 'eliminar', `√Årea eliminada: ${area}`, { nombre: area }, null);
                    actualizarSelectsConfiguracion();
                    crearMatriz();
                    actualizarFiltrosAnalisis();
                    actualizarListaAreas();
                    mostrarAlerta('üóëÔ∏è √Årea eliminada', 'alert');
                }
            }
        }

        function agregarPuesto() {
            const nuevoPuesto = document.getElementById('nuevoPuesto').value.trim();
            const areaPuesto = document.getElementById('areaPuesto').value;
            const jefePuesto = document.getElementById('jefePuesto').value;
            const nivelPuesto = document.getElementById('nivelPuesto').value;
            
            if (nuevoPuesto && !puestos.find(p => p.nombre === nuevoPuesto)) {
                const puestoCompleto = {
                    nombre: nuevoPuesto,
                    area: areaPuesto,
                    jefe: jefePuesto,
                    nivel: nivelPuesto,
                    fechaCreacion: new Date().toISOString(),
                    usuarioCreacion: usuarioActual.nombre
                };
                
                puestos.push(puestoCompleto);
                registrarCambio('sistema', 'crear', `Nuevo puesto creado: ${nuevoPuesto} (${areaPuesto})`, null, puestoCompleto);
                actualizarSelectsConfiguracion();
                limpiarFormularioPuestos();
                actualizarListaPuestos();
                mostrarAlerta('‚úÖ Puesto agregado correctamente', 'success');
            } else if (puestos.find(p => p.nombre === nuevoPuesto)) {
                mostrarAlerta('‚ùå Este puesto ya existe', 'alert');
            } else {
                mostrarAlerta('‚ùå Ingresa un nombre para el puesto', 'alert');
            }
        }

        function limpiarFormularioPuestos() {
            document.getElementById('nuevoPuesto').value = '';
            document.getElementById('areaPuesto').selectedIndex = 0;
            document.getElementById('jefePuesto').selectedIndex = 0;
            document.getElementById('nivelPuesto').selectedIndex = 0;
        }

        // CORRECCI√ìN: Funci√≥n para editar puesto con modal completo
        function editarPuesto(index) {
            const puesto = puestos[index];
            const modal = document.createElement('div');
            modal.id = 'modalEditarPuesto';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 15px; padding: 30px; max-width: 500px; width: 90%;">
                        <h3 style="margin-bottom: 20px;">‚úèÔ∏è Editar Puesto</h3>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Nombre del Puesto:</label>
                                <input type="text" id="editNombrePuesto" value="${puesto.nombre}" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 5px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">√Årea:</label>
                                <select id="editAreaPuesto" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 5px;">
                                    <option value="">Seleccionar √°rea...</option>
                                    ${areas.map(a => `<option value="${a}" ${a === puesto.area ? 'selected' : ''}>${a}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Jefe Inmediato:</label>
                                <select id="editJefePuesto" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 5px;">
                                    <option value="">Sin jefe asignado</option>
                                    ${puestos.map(p => `<option value="${p.nombre}" ${p.nombre === puesto.jefe ? 'selected' : ''}>${p.nombre}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Nivel Organizacional:</label>
                                <select id="editNivelPuesto" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 5px;">
                                    <option value="Directivo" ${puesto.nivel === 'Directivo' ? 'selected' : ''}>Directivo</option>
                                    <option value="Gerencial" ${puesto.nivel === 'Gerencial' ? 'selected' : ''}>Gerencial</option>
                                    <option value="Supervisi√≥n" ${puesto.nivel === 'Supervisi√≥n' ? 'selected' : ''}>Supervisi√≥n</option>
                                    <option value="Operativo" ${puesto.nivel === 'Operativo' ? 'selected' : ''}>Operativo</option>
                                    <option value="Apoyo" ${puesto.nivel === 'Apoyo' ? 'selected' : ''}>Apoyo</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button onclick="guardarEdicionPuestoConfig(${index})" style="flex: 1; background: #38a169; color: white; border: none; border-radius: 8px; padding: 12px; cursor: pointer; font-weight: 600;">üíæ Guardar</button>
                            <button onclick="cerrarModalEditarPuesto()" style="flex: 1; background: #e53e3e; color: white; border: none; border-radius: 8px; padding: 12px; cursor: pointer; font-weight: 600;">‚ùå Cancelar</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function guardarEdicionPuestoConfig(index) {
            const puestoAnterior = {...puestos[index]};
            
            puestos[index] = {
                ...puestos[index],
                nombre: document.getElementById('editNombrePuesto').value.trim(),
                area: document.getElementById('editAreaPuesto').value,
                jefe: document.getElementById('editJefePuesto').value,
                nivel: document.getElementById('editNivelPuesto').value,
                fechaModificacion: new Date().toISOString(),
                usuarioModificacion: usuarioActual.nombre
            };
            
            registrarCambio('sistema', 'modificar', `Puesto modificado: ${puestos[index].nombre}`, puestoAnterior, puestos[index]);
            
            actualizarSelectsConfiguracion();
            actualizarListaPuestos();
            cerrarModalEditarPuesto();
            mostrarAlerta('‚úÖ Puesto actualizado', 'success');
        }

        function cerrarModalEditarPuesto() {
            const modal = document.getElementById('modalEditarPuesto');
            if (modal) modal.remove();
        }

        function eliminarPuesto(nombrePuesto) {
            const index = puestos.findIndex(p => p.nombre === nombrePuesto);
            if (index >= 6) { // Solo eliminar puestos no predefinidos
                if (confirm(`¬øEliminar el puesto "${nombrePuesto}"?`)) {
                    const puesto = puestos[index];
                    puestos.splice(index, 1);
                    registrarCambio('sistema', 'eliminar', `Puesto eliminado: ${nombrePuesto}`, puesto, null);
                    actualizarSelectsConfiguracion();
                    actualizarListaPuestos();
                    mostrarAlerta('üóëÔ∏è Puesto eliminado', 'alert');
                }
            }
        }

        function agregarSistema() {
            const nuevoSistema = document.getElementById('nuevoSistema').value.trim();
            if (nuevoSistema && !sistemas.includes(nuevoSistema)) {
                sistemas.push(nuevoSistema);
                registrarCambio('sistema', 'crear', `Nuevo sistema creado: ${nuevoSistema}`, null, { nombre: nuevoSistema });
                actualizarSelectsConfiguracion();
                document.getElementById('nuevoSistema').value = '';
                actualizarListaSistemas();
                mostrarAlerta('‚úÖ Sistema agregado correctamente', 'success');
            } else if (sistemas.includes(nuevoSistema)) {
                mostrarAlerta('‚ùå Este sistema ya existe', 'alert');
            } else {
                mostrarAlerta('‚ùå Ingresa un nombre para el sistema', 'alert');
            }
        }

        // CORRECCI√ìN: Funci√≥n para editar sistema  
        function editarSistema(sistemaAntiguo) {
            const sistemaNuevo = prompt('Nuevo nombre para el sistema:', sistemaAntiguo);
            if (sistemaNuevo && sistemaNuevo.trim() && sistemaNuevo.trim() !== sistemaAntiguo) {
                const index = sistemas.indexOf(sistemaAntiguo);
                if (index !== -1) {
                    sistemas[index] = sistemaNuevo.trim();
                    
                    // Actualizar en procesos
                    procesos.forEach(proceso => {
                        if (Array.isArray(proceso.sistemas)) {
                            const indexSistema = proceso.sistemas.indexOf(sistemaAntiguo);
                            if (indexSistema !== -1) {
                                proceso.sistemas[indexSistema] = sistemaNuevo.trim();
                            }
                        } else if (proceso.sistemas === sistemaAntiguo) {
                            proceso.sistemas = sistemaNuevo.trim();
                        }
                    });
                    
                    // Actualizar en costos
                    costosSistemas.forEach(costo => {
                        if (costo.sistema === sistemaAntiguo) {
                            costo.sistema = sistemaNuevo.trim();
                        }
                    });
                    
                    registrarCambio('sistema', 'modificar', `Sistema modificado: ${sistemaAntiguo} ‚Üí ${sistemaNuevo.trim()}`, 
                        { nombre: sistemaAntiguo }, { nombre: sistemaNuevo.trim() });
                    
                    actualizarSelectsConfiguracion();
                    actualizarListaSistemas();
                    mostrarAlerta('‚úÖ Sistema actualizado correctamente', 'success');
                }
            }
        }

        function eliminarSistema(sistema) {
            const index = sistemas.indexOf(sistema);
            if (index >= 6) { // Solo eliminar sistemas no predefinidos
                if (confirm(`¬øEliminar el sistema "${sistema}"?`)) {
                    sistemas.splice(index, 1);
                    registrarCambio('sistema', 'eliminar', `Sistema eliminado: ${sistema}`, { nombre: sistema }, null);
                    actualizarSelectsConfiguracion();
                    actualizarListaSistemas();
                    mostrarAlerta('üóëÔ∏è Sistema eliminado', 'alert');
                }
            }
        }

        // CORRECCI√ìN: HTML corregido para listas con botones editar/eliminar
        function actualizarListaAreas() {
            const lista = document.getElementById('listaAreas');
            if (!lista) return;
            lista.innerHTML = '';
            
            areas.forEach((area, index) => {
                const div = document.createElement('div');
                div.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #f7fafc; border-radius: 5px; margin-bottom: 5px;';
                div.innerHTML = `
                    <span>${area}</span>
                    <div>
                        <button onclick="editarArea('${area}')" style="background: #3182ce; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 12px; margin-right: 5px;">‚úèÔ∏è Editar</button>
                        ${index >= 6 ? `<button onclick="eliminarArea('${area}')" style="background: #e53e3e; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 12px;">üóëÔ∏è Eliminar</button>` : '<small style="color: #666;">Predefinida</small>'}
                    </div>
                `;
                lista.appendChild(div);
            });
        }

        function actualizarListaPuestos() {
            const lista = document.getElementById('listaPuestos');
            if (!lista) return;
            lista.innerHTML = '';
            
            puestos.forEach((puesto, index) => {
                const div = document.createElement('div');
                div.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #f7fafc; border-radius: 5px; margin-bottom: 5px;';
                div.innerHTML = `
                    <div>
                        <strong>${puesto.nombre}</strong>
                        <br><small style="color: #666;">${puesto.area || 'Sin √°rea'} - ${puesto.nivel}${puesto.jefe ? ` - Jefe: ${puesto.jefe}` : ''}</small>
                    </div>
                    <div>
                        <button onclick="editarPuesto(${index})" style="background: #3182ce; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 12px; margin-right: 5px;">‚úèÔ∏è Editar</button>
                        ${index >= 6 ? `<button onclick="eliminarPuesto('${puesto.nombre}')" style="background: #e53e3e; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 12px;">üóëÔ∏è Eliminar</button>` : '<small style="color: #666;">Predefinido</small>'}
                    </div>
                `;
                lista.appendChild(div);
            });
        }

        function actualizarListaSistemas() {
            const lista = document.getElementById('listaSistemas');
            if (!lista) return;
            lista.innerHTML = '';
            
            sistemas.forEach((sistema, index) => {
                const div = document.createElement('div');
                div.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #f7fafc; border-radius: 5px; margin-bottom: 5px;';
                div.innerHTML = `
                    <span>${sistema}</span>
                    <div>
                        <button onclick="editarSistema('${sistema}')" style="background: #3182ce; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 12px; margin-right: 5px;">‚úèÔ∏è Editar</button>
                        ${index >= 6 ? `<button onclick="eliminarSistema('${sistema}')" style="background: #e53e3e; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 12px;">üóëÔ∏è Eliminar</button>` : '<small style="color: #666;">Predefinido</small>'}
                    </div>
                `;
                lista.appendChild(div);
            });
        }

        function actualizarListaCostosSistemas() {
            const lista = document.getElementById('listaCostosSistemas');
            if (!lista) return;
            
            lista.innerHTML = '';
            
            if (costosSistemas.length === 0) {
                lista.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No hay costos registrados</p>';
                return;
            }
            
            costosSistemas.forEach((costo, index) => {
                const fechaCreacion = new Date(costo.fechaCreacion).toLocaleDateString();
                const costoMensual = costo.frecuenciaPago === 'Anual' ? (costo.costoTotal / 12).toFixed(2) : costo.costoTotal;
                
                const div = document.createElement('div');
                div.style.cssText = 'border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin-bottom: 10px; background: #f7fafc;';
                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div>
                            <strong>${costo.sistema}</strong>
                            <br><span style="color: #666; font-size: 14px;">${costo.descripcion}</span>
                        </div>
                        <div>
                            <button onclick="editarCostoSistema(${index})" style="background: #3182ce; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer; font-size: 12px; margin-right: 5px;">‚úèÔ∏è Editar</button>
                            <button onclick="eliminarCostoSistema(${index})" style="background: #e53e3e; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer; font-size: 12px;">üóëÔ∏è Eliminar</button>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <p style="color: #666; margin: 0;"><strong>Costo Total:</strong> ${costo.costoTotal.toLocaleString()} ${costo.moneda || 'MXN'}</p>
                        <p style="color: #666; margin: 0;"><strong>Costo Mensual:</strong> ${parseFloat(costoMensual).toLocaleString()} ${costo.moneda || 'MXN'}</p>
                        <p style="color: #666; margin: 0;"><strong>Licencias:</strong> ${costo.numLicencias || 'N/A'}</p>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <p style="color: #666; margin: 0;"><strong>Forma de Pago:</strong> ${costo.formaPago}</p>
                        <p style="color: #666; margin: 0;"><strong>Frecuencia:</strong> ${costo.frecuenciaPago}</p>
                    </div>
                    ${costo.otrosEspecificar ? `<p style="color: #666; margin: 5px 0 0 0;"><strong>Otros:</strong> ${costo.otrosEspecificar}</p>` : ''}
                    <div class="auditoria-info">üìÖ Registrado: ${fechaCreacion} por ${costo.usuarioCreacion || 'Sistema'}</div>
                `;
                lista.appendChild(div);
            });
        }

        function agregarCostoSistema() {
            const sistema = document.getElementById('sistemaCoste').value;
            const descripcion = document.getElementById('descripcionCosto').value;
            const costoPorUso = document.getElementById('costoPorUso').checked;
            const costoPorUsoValor = parseFloat(document.getElementById('costoPorUsoValor').value) || 0;
            const costoPorLicencia = document.getElementById('costoPorLicencia').checked;
            const costoPorLicenciaValor = parseFloat(document.getElementById('costoPorLicenciaValor').value) || 0;
            const numLicencias = parseInt(document.getElementById('numLicencias').value) || 0;
            const formaPago = document.getElementById('formaPago').value;
            const frecuenciaPago = document.getElementById('frecuenciaPago').value;
            const otrosEspecificar = document.getElementById('otrosEspecificar').value;

            if (sistema && (costoPorUso || costoPorLicencia)) {
                const costoTotal = (costoPorUso ? costoPorUsoValor : 0) + (costoPorLicencia ? costoPorLicenciaValor * numLicencias : 0);
                
                const existeIndex = costosSistemas.findIndex(c => c.sistema === sistema);
                
                const nuevoCosto = {
                    sistema, 
                    descripcion,
                    moneda: 'MXN',
                    costoPorUso,
                    costoPorUsoValor,
                    costoPorLicencia,
                    costoPorLicenciaValor,
                    numLicencias,
                    costoTotal,
                    formaPago,
                    frecuenciaPago,
                    otrosEspecificar,
                    id: Date.now(),
                    fechaCreacion: new Date().toISOString(),
                    usuarioCreacion: usuarioActual.nombre
                };
                
                if (existeIndex >= 0) {
                    registrarCambio('sistema', 'modificar', `Costo de sistema modificado: ${sistema}`, costosSistemas[existeIndex], nuevoCosto);
                    costosSistemas[existeIndex] = nuevoCosto;
                } else {
                    registrarCambio('sistema', 'crear', `Nuevo costo de sistema registrado: ${sistema}`, null, nuevoCosto);
                    costosSistemas.push(nuevoCosto);
                }

                actualizarListaCostosSistemas();
                actualizarDashboard();
                limpiarFormularioCostos();
                mostrarAlerta('‚úÖ Costo de sistema registrado', 'success');
            } else {
                mostrarAlerta('‚ùå Selecciona un sistema y al menos un tipo de costo', 'alert');
            }
        }

        function limpiarFormularioCostos() {
            document.getElementById('sistemaCoste').selectedIndex = 0;
            document.getElementById('descripcionCosto').value = '';
            document.getElementById('costoPorUso').checked = false;
            document.getElementById('costoPorUsoValor').value = '';
            document.getElementById('costoPorUsoValor').disabled = true;
            document.getElementById('costoPorLicencia').checked = false;
            document.getElementById('costoPorLicenciaValor').value = '';
            document.getElementById('numLicencias').value = '';
            document.getElementById('costoPorLicenciaValor').disabled = true;
            document.getElementById('numLicencias').disabled = true;
            document.getElementById('formaPago').selectedIndex = 0;
            document.getElementById('frecuenciaPago').selectedIndex = 0;
            document.getElementById('otrosEspecificar').value = '';
        }

        function editarCostoSistema(index) {
            const costo = costosSistemas[index];
            document.getElementById('sistemaCoste').value = costo.sistema;
            document.getElementById('descripcionCosto').value = costo.descripcion;
            document.getElementById('costoPorUso').checked = costo.costoPorUso;
            document.getElementById('costoPorUsoValor').value = costo.costoPorUsoValor;
            document.getElementById('costoPorUsoValor').disabled = !costo.costoPorUso;
            document.getElementById('costoPorLicencia').checked = costo.costoPorLicencia;
            document.getElementById('costoPorLicenciaValor').value = costo.costoPorLicenciaValor;
            document.getElementById('numLicencias').value = costo.numLicencias;
            document.getElementById('costoPorLicenciaValor').disabled = !costo.costoPorLicencia;
            document.getElementById('numLicencias').disabled = !costo.costoPorLicencia;
            document.getElementById('formaPago').value = costo.formaPago;
            document.getElementById('frecuenciaPago').value = costo.frecuenciaPago;
            document.getElementById('otrosEspecificar').value = costo.otrosEspecificar;
            
            costosSistemas.splice(index, 1);
            actualizarListaCostosSistemas();
            mostrarAlerta('üí° Datos cargados en formulario. Modifica y presiona "Registrar Costo" para guardar.', 'alert');
        }

        function eliminarCostoSistema(index) {
            if (confirm('¬øEliminar este registro de costo?')) {
                const costo = costosSistemas[index];
                registrarCambio('sistema', 'eliminar', `Costo de sistema eliminado: ${costo.sistema}`, costo, null);
                
                costosSistemas.splice(index, 1);
                actualizarListaCostosSistemas();
                actualizarDashboard();
                mostrarAlerta('üóëÔ∏è Costo eliminado', 'alert');
            }
        }

        // Funciones de gesti√≥n de actividades
        function mostrarGestionActividades() {
            actualizarEstadisticasActividades();
            filtrarActividades();
        }

        function actualizarEstadisticasActividades() {
            const totalActividades = actividades.length;
            const actividadesActivasCount = actividades.filter(a => !actividadesInactivas.includes(a)).length;
            const actividadesInactivasCount = actividadesInactivas.length;
            
            const actividadesEnUsoSet = new Set();
            procesos.forEach(p => {
                if (p.actividades) {
                    p.actividades.forEach(a => actividadesEnUsoSet.add(a));
                }
            });
            const actividadesEnUsoCount = actividadesEnUsoSet.size;
            
            document.getElementById('totalActividades').textContent = totalActividades;
            document.getElementById('actividadesActivas').textContent = actividadesActivasCount;
            document.getElementById('actividadesInactivas').textContent = actividadesInactivasCount;
            document.getElementById('actividadesEnUso').textContent = actividadesEnUsoCount;
        }

        function agregarActividadGestion() {
            const nuevaActividad = document.getElementById('nuevaActividadGestion').value.trim();
            
            if (nuevaActividad && !actividades.includes(nuevaActividad)) {
                actividades.push(nuevaActividad);
                document.getElementById('nuevaActividadGestion').value = '';
                registrarCambio('actividad', 'crear', `Nueva actividad creada: ${nuevaActividad}`, null, { nombre: nuevaActividad });
                crearMatriz();
                actualizarFiltrosAnalisis();
                mostrarGestionActividades();
                
                // Actualizar validaci√≥n en captura si est√° visible
                const capturaTab = document.getElementById('captura');
                if (capturaTab && capturaTab.classList.contains('active')) {
                    validarActividadesDisponibles();
                }
                
                mostrarAlerta('‚úÖ Actividad agregada correctamente', 'success');
            } else if (actividades.includes(nuevaActividad)) {
                mostrarAlerta('‚ùå Esta actividad ya existe', 'alert');
            } else {
                mostrarAlerta('‚ùå Ingresa un nombre para la actividad', 'alert');
            }
        }

        function filtrarActividades() {
            const filtroEstado = document.getElementById('filtroEstadoActividad')?.value || '';
            const filtroBuscar = document.getElementById('filtroBuscarActividad')?.value.toLowerCase() || '';
            const filtroUso = document.getElementById('filtroUsoActividad')?.value || '';
            
            const actividadesEnUsoSet = new Set();
            procesos.forEach(p => {
                if (p.actividades) {
                    p.actividades.forEach(a => actividadesEnUsoSet.add(a));
                }
            });
            
            const actividadesFiltradas = actividades.filter(actividad => {
                const esActiva = !actividadesInactivas.includes(actividad);
                const cumpleEstado = !filtroEstado || 
                    (filtroEstado === 'activa' && esActiva) ||
                    (filtroEstado === 'inactiva' && !esActiva);
                
                const cumpleBusqueda = !filtroBuscar || 
                    actividad.toLowerCase().includes(filtroBuscar);
                
                const estaEnUso = actividadesEnUsoSet.has(actividad);
                const cumpleUso = !filtroUso ||
                    (filtroUso === 'usada' && estaEnUso) ||
                    (filtroUso === 'no-usada' && !estaEnUso);
                
                return cumpleEstado && cumpleBusqueda && cumpleUso;
            });
            
            mostrarListaActividadesFiltrada(actividadesFiltradas, actividadesEnUsoSet);
        }

        function mostrarListaActividadesFiltrada(actividadesFiltradas, actividadesEnUsoSet) {
            const container = document.getElementById('listaActividadesGestionCompleta');
            if (!container) return;
            
            if (actividadesFiltradas.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No hay actividades que coincidan con los filtros</p>';
                return;
            }
            
            let html = '<div class="actividades-gestion">';
            actividadesFiltradas.forEach((actividad) => {
                const realIndex = actividades.indexOf(actividad);
                const estado = actividadesInactivas.includes(actividad) ? 'inactiva' : 'activa';
                const estadoIcono = estado === 'activa' ? 'üü¢' : 'üî¥';
                const estadoTexto = estado === 'activa' ? 'Activa' : 'Inactiva';
                const botonEstado = estado === 'activa' ? 'Inactivar' : 'Activar';
                const enUso = actividadesEnUsoSet.has(actividad);
                const usoIcono = enUso ? '‚úÖ' : '‚ùå';
                const usoTexto = enUso ? 'En uso' : 'Sin uso';
                
                html += `
                    <div class="actividad-item ${estado}">
                        <div>
                            <span>${estadoIcono} <strong>${actividad}</strong> (${estadoTexto})</span><br>
                            <small style="color: #666;">${usoIcono} ${usoTexto} ${enUso ? '- Usada en ' + contarUsosActividad(actividad) + ' proceso(s)' : ''}</small>
                        </div>
                        <div class="botones-actividad">
                            <button onclick="editarActividadGestion(${realIndex})" class="btn-editar">‚úèÔ∏è Editar</button>
                            <button onclick="toggleEstadoActividadGestion('${actividad}')" class="btn-estado">${botonEstado}</button>
                            <button onclick="eliminarActividadGestion(${realIndex})" class="btn-eliminar" ${enUso ? 'disabled title="No se puede eliminar: est√° en uso"' : ''}>üóëÔ∏è Eliminar</button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function contarUsosActividad(actividad) {
            return procesos.filter(p => p.actividades && p.actividades.includes(actividad)).length;
        }

        function editarActividadGestion(index) {
            const antiguoNombre = actividades[index];
            const nuevoNombre = prompt('Nuevo nombre para la actividad:', antiguoNombre);
            if (nuevoNombre && nuevoNombre.trim() && nuevoNombre.trim() !== antiguoNombre) {
                actividades[index] = nuevoNombre.trim();
                
                procesos.forEach(proceso => {
                    if (proceso.actividades) {
                        const indexEnProceso = proceso.actividades.indexOf(antiguoNombre);
                        if (indexEnProceso !== -1) {
                            proceso.actividades[indexEnProceso] = nuevoNombre.trim();
                        }
                    }
                });
                
                const indexInactiva = actividadesInactivas.indexOf(antiguoNombre);
                if (indexInactiva !== -1) {
                    actividadesInactivas[indexInactiva] = nuevoNombre.trim();
                }
                
                registrarCambio('actividad', 'modificar', `Actividad modificada: ${antiguoNombre} ‚Üí ${nuevoNombre.trim()}`, 
                    { nombre: antiguoNombre }, { nombre: nuevoNombre.trim() });
                
                crearMatriz();
                actualizarFiltrosAnalisis();
                mostrarGestionActividades();
                mostrarVistaProcesosYFlujos();
                mostrarAlerta('‚úÖ Actividad actualizada correctamente', 'success');
            }
        }

        function toggleEstadoActividadGestion(actividad) {
            const index = actividadesInactivas.indexOf(actividad);
            let accion = '';
            if (index === -1) {
                actividadesInactivas.push(actividad);
                accion = 'inactivar';
                mostrarAlerta(`üî¥ Actividad "${actividad}" inactivada`, 'alert');
            } else {
                actividadesInactivas.splice(index, 1);
                accion = 'activar';
                mostrarAlerta(`üü¢ Actividad "${actividad}" activada`, 'success');
            }
            
            registrarCambio('actividad', accion, `Actividad ${accion}da: ${actividad}`, null, { nombre: actividad, estado: accion === 'activar' ? 'activa' : 'inactiva' });
            
            crearMatriz();
            mostrarGestionActividades();
        }

        function eliminarActividadGestion(index) {
            const actividad = actividades[index];
            const enUso = contarUsosActividad(actividad) > 0;
            
            if (enUso) {
                mostrarAlerta('‚ùå No se puede eliminar: la actividad est√° en uso en procesos', 'alert');
                return;
            }
            
            if (confirm(`¬øEst√°s seguro de eliminar la actividad "${actividad}"?`)) {
                actividades.splice(index, 1);
                
                const indexInactiva = actividadesInactivas.indexOf(actividad);
                if (indexInactiva !== -1) {
                    actividadesInactivas.splice(indexInactiva, 1);
                }
                
                registrarCambio('actividad', 'eliminar', `Actividad eliminada: ${actividad}`, { nombre: actividad }, null);
                
                crearMatriz();
                actualizarFiltrosAnalisis();
                mostrarGestionActividades();
                mostrarAlerta('üóëÔ∏è Actividad eliminada correctamente', 'alert');
            }
        }

        function limpiarFiltrosActividades() {
            document.getElementById('filtroEstadoActividad').value = '';
            document.getElementById('filtroBuscarActividad').value = '';
            document.getElementById('filtroUsoActividad').value = '';
            filtrarActividades();
        }

        // Funci√≥n para crear matriz
        function crearMatriz() {
            const headerMatriz = document.getElementById('headerMatriz');
            const matrizBody = document.getElementById('matrizBody');
            
            if (!headerMatriz || !matrizBody) return;
            
            headerMatriz.innerHTML = '<th style="width: 250px;">Actividad</th>';
            matrizBody.innerHTML = '';
            
            // Aplicar filtros
            const filtroAreas = document.getElementById('filtroAreaAnalisis')?.value.toLowerCase() || '';
            const filtroActividades = document.getElementById('filtroActividadAnalisis')?.value.toLowerCase() || '';
            const filtroEstadoActividad = document.getElementById('filtroEstadoActividadAnalisis')?.value || '';
            
            const areasFiltradas = areas.filter(area => 
                area.toLowerCase().includes(filtroAreas)
            );
            
            let actividadesFiltradas = actividades.filter(actividad => 
                actividad.toLowerCase().includes(filtroActividades)
            );
            
            if (filtroEstadoActividad) {
                actividadesFiltradas = actividadesFiltradas.filter(actividad => {
                    const esActiva = !actividadesInactivas.includes(actividad);
                    return (filtroEstadoActividad === 'activa' && esActiva) || 
                           (filtroEstadoActividad === 'inactiva' && !esActiva);
                });
            }
            
            // Crear header con √°reas filtradas
            areasFiltradas.forEach(area => {
                const th = document.createElement('th');
                th.textContent = area;
                th.style.minWidth = '120px';
                headerMatriz.appendChild(th);
            });
            
            // Crear filas de actividades filtradas
            actividadesFiltradas.forEach((actividad) => {
                const row = document.createElement('tr');
                
                const cellActividad = document.createElement('td');
                cellActividad.style.fontWeight = 'bold';
                cellActividad.style.textAlign = 'left';
                cellActividad.style.padding = '8px';
                
                const esActiva = !actividadesInactivas.includes(actividad);
                const estadoIcono = esActiva ? 'üü¢' : 'üî¥';
                cellActividad.innerHTML = `${estadoIcono} ${actividad}`;
                
                row.appendChild(cellActividad);
                
                // Crear checkboxes para √°reas filtradas
                areasFiltradas.forEach(area => {
                    const cell = document.createElement('td');
                    cell.className = 'checkbox-cell';
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.setAttribute('data-area', area);
                    checkbox.setAttribute('data-actividad', actividad);
                    checkbox.onchange = function() {
                        verificarDuplicidadesEnMatriz();
                    };
                    cell.appendChild(checkbox);
                    row.appendChild(cell);
                });
                
                matrizBody.appendChild(row);
            });
        }

        function verificarDuplicidadesEnMatriz() {
            actividades.forEach(actividad => {
                const checkboxes = document.querySelectorAll(`input[data-actividad="${actividad}"]:checked`);
                if (checkboxes.length > 1) {
                    checkboxes.forEach(cb => {
                        cb.closest('td').classList.add('duplicado');
                    });
                } else {
                    document.querySelectorAll(`input[data-actividad="${actividad}"]`).forEach(cb => {
                        cb.closest('td').classList.remove('duplicado');
                    });
                }
            });
        }

        function actualizarFiltrosAnalisis() {
            const filtroAreas = document.getElementById('filtroAreaAnalisis');
            if (filtroAreas) {
                filtroAreas.innerHTML = '<option value="">Todas las √°reas</option>';
                areas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area;
                    option.textContent = area;
                    filtroAreas.appendChild(option);
                });
            }
            
            const filtroActividades = document.getElementById('filtroActividadAnalisis');
            if (filtroActividades) {
                filtroActividades.innerHTML = '<option value="">Todas las actividades</option>';
                actividades.forEach(actividad => {
                    const option = document.createElement('option');
                    option.value = actividad;
                    option.textContent = actividad;
                    filtroActividades.appendChild(option);
                });
            }
        }

        function filtrarMatriz() {
            crearMatriz();
        }

        function limpiarFiltrosAnalisis() {
            document.getElementById('filtroAreaAnalisis').value = '';
            document.getElementById('filtroActividadAnalisis').value = '';
            document.getElementById('filtroEstadoActividadAnalisis').value = '';
            filtrarMatriz();
        }

        function llenarMatrizAutomatica() {
            if (confirm('¬øLlenar la matriz autom√°ticamente basado en los procesos capturados?')) {
                document.querySelectorAll('.matriz input[type="checkbox"]').forEach(cb => cb.checked = false);
                
                procesos.filter(p => p.activo).forEach(proceso => {
                    if (proceso.actividades) {
                        proceso.actividades.forEach(actividad => {
                            const checkbox = document.querySelector(`input[data-area="${proceso.area}"][data-actividad="${actividad}"]`);
                            if (checkbox) checkbox.checked = true;
                        });
                    }
                });
                
                verificarDuplicidadesEnMatriz();
                mostrarAlerta('ü§ñ Matriz llenada autom√°ticamente', 'success');
            }
        }

        function analizarDuplicidades() {
            let duplicidades = 0;
            
            actividades.forEach(actividad => {
                const checkboxes = document.querySelectorAll(`input[data-actividad="${actividad}"]:checked`);
                if (checkboxes.length > 1) {
                    duplicidades++;
                    checkboxes.forEach(cb => {
                        cb.closest('td').classList.add('duplicado');
                    });
                } else {
                    document.querySelectorAll(`input[data-actividad="${actividad}"]`).forEach(cb => {
                        cb.closest('td').classList.remove('duplicado');
                    });
                }
            });

            document.getElementById('duplicidadesEncontradas').textContent = duplicidades;
            
            if (duplicidades > 0) {
                mostrarAlerta(`‚ö†Ô∏è Se detectaron ${duplicidades} actividades duplicadas en la matriz`, 'alert');
                generarPlanDeAccion();
            } else {
                mostrarAlerta('‚úÖ No se detectaron duplicidades en la matriz', 'success');
            }
        }

        function actualizarAnalisisCompleto() {
            actualizarOportunidades();
            generarDeteccionesAutomaticas();
            analizarDuplicidades();
            mostrarAlerta('üîÑ An√°lisis actualizado completamente', 'success');
        }

        // Funci√≥n para mostrar vista de procesos
        function mostrarVistaProcesosYFlujos() {
            const container = document.getElementById('listaProcesosYFlujos');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (procesos.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No hay procesos registrados</p>';
                return;
            }
            
            procesos.sort((a, b) => b.id - a.id).forEach(proceso => {
                const realIndex = procesos.findIndex(p => p.id === proceso.id);
                const estadoTexto = proceso.activo ? 'Activo' : 'Inactivo';
                const estadoColor = proceso.activo ? '#38a169' : '#e53e3e';
                const estadoBoton = proceso.activo ? 'Inactivar' : 'Activar';
                
                const div = document.createElement('div');
                div.style.cssText = `border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: ${proceso.activo ? '#f7fafc' : '#fdf2f8'}; border-left: 5px solid #667eea;`;
                
                const sistemasTexto = Array.isArray(proceso.sistemas) ? proceso.sistemas.join(', ') : proceso.sistemas || 'Sin sistemas';
                
                let infoFlujo = '';
                if (proceso.flujoInfo) {
                    const info = proceso.flujoInfo;
                    if (info.fuentesRecibe && info.fuentesRecibe.length > 0) {
                        infoFlujo += `<p style="color: #666; margin-bottom: 5px;"><strong>üì• Recibe de:</strong> ${info.fuentesRecibe.join(', ')}</p>`;
                        if (info.descripcionRecibe) {
                            infoFlujo += `<p style="color: #666; margin-bottom: 5px; padding-left: 15px;"><em>${info.descripcionRecibe}</em></p>`;
                        }
                        if (info.formatosRecibe && info.formatosRecibe.length > 0) {
                            infoFlujo += `<p style="color: #666; margin-bottom: 5px; padding-left: 15px;"><strong>Formatos:</strong> ${info.formatosRecibe.join(', ')}</p>`;
                        }
                    }
                    if (info.destinosEntrega && info.destinosEntrega.length > 0) {
                        infoFlujo += `<p style="color: #666; margin-bottom: 5px;"><strong>üì§ Entrega a:</strong> ${info.destinosEntrega.join(', ')}</p>`;
                        if (info.descripcionEntrega) {
                            infoFlujo += `<p style="color: #666; margin-bottom: 5px; padding-left: 15px;"><em>${info.descripcionEntrega}</em></p>`;
                        }
                        if (info.formatosEntrega && info.formatosEntrega.length > 0) {
                            infoFlujo += `<p style="color: #666; margin-bottom: 5px; padding-left: 15px;"><strong>Formatos:</strong> ${info.formatosEntrega.join(', ')}</p>`;
                        }
                    }
                }
                
                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div>
                            <span style="background: #667eea; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-right: 10px;">üìã PROCESO</span>
                            <strong style="color: #4a5568;">${proceso.area} - ${proceso.descripcion}</strong>
                            <span style="background: ${estadoColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-left: 10px;">${estadoTexto}</span>
                        </div>
                        <div>
                            <button onclick="editarProceso(${realIndex})" style="background: #3182ce; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer; font-size: 12px; margin-right: 5px;">‚úèÔ∏è Editar</button>
                            <button onclick="toggleActivoProceso(${realIndex})" style="background: ${proceso.activo ? '#f56565' : '#38a169'}; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer; font-size: 12px; margin-right: 5px;">${estadoBoton}</button>
                            <button onclick="eliminarProceso(${realIndex})" style="background: #e53e3e; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer; font-size: 12px;">üóëÔ∏è Eliminar</button>
                        </div>
                    </div>
                    ${proceso.puesto ? `<p style="color: #666; margin-bottom: 8px;"><strong>Puesto:</strong> ${proceso.puesto}</p>` : ''}
                    <p style="color: #666; margin-bottom: 5px;"><strong>Sistemas:</strong> ${sistemasTexto}</p>
                    ${proceso.actividades && proceso.actividades.length > 0 ? `<p style="color: #666; margin-bottom: 5px;"><strong>Actividades:</strong> ${proceso.actividades.join(', ')}</p>` : ''}
                    <p style="color: #666; margin-bottom: 5px;"><strong>Tiempo:</strong> ${proceso.tiempo} min | <strong>Frecuencia:</strong> ${proceso.frecuencia}</p>
                    ${infoFlujo}
                    ${proceso.fechaCreacion ? `<div class="auditoria-info">üìÖ Creado: ${new Date(proceso.fechaCreacion).toLocaleDateString()} por ${proceso.usuarioCreacion || 'Sistema'}</div>` : ''}
                `;
                container.appendChild(div);
            });
        }

        function editarProceso(index) {
            const proceso = procesos[index];
            const modal = document.createElement('div');
            modal.id = 'modalEditarProceso';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 15px; padding: 30px; max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <h3 style="margin-bottom: 20px;">‚úèÔ∏è Editar Proceso</h3>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">√Årea:</label>
                                <select id="editAreaProceso" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 5px;">
                                    <option value="">Seleccionar √°rea...</option>
                                    ${areas.map(a => `<option value="${a}" ${a === proceso.area ? 'selected' : ''}>${a}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Puesto:</label>
                                <select id="editPuestoProceso" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 5px;">
                                    <option value="">Seleccionar puesto...</option>
                                    ${puestos.map(p => `<option value="${p.nombre}" ${p.nombre === proceso.puesto ? 'selected' : ''}>${p.nombre}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Proceso:</label>
                            <input type="text" id="editNombreProceso" value="${proceso.descripcion}" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 5px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Sistemas:</label>
                            <div id="editSistemasContainer" style="border: 1px solid #e2e8f0; border-radius: 5px; padding: 10px; min-height: 50px;">
                                ${Array.isArray(proceso.sistemas) ? proceso.sistemas.map(s => `<span class="multi-select-item">${s} <span class="remove" onclick="eliminarSistemaEdit('${s}')">√ó</span></span>`).join('') : (proceso.sistemas ? `<span class="multi-select-item">${proceso.sistemas} <span class="remove" onclick="eliminarSistemaEdit('${proceso.sistemas}')">√ó</span></span>` : '')}
                            </div>
                            <div style="margin-top: 10px;">
                                <select id="editAgregarSistema" style="width: calc(100% - 80px); padding: 6px; border: 1px solid #e2e8f0; border-radius: 5px; margin-right: 10px;">
                                    <option value="">Seleccionar sistema...</option>
                                    ${sistemas.map(s => `<option value="${s}">${s}</option>`).join('')}
                                </select>
                                <button onclick="agregarSistemaEdit()" style="padding: 6px 12px; background: #38a169; color: white; border: none; border-radius: 5px; cursor: pointer;">+</button>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Actividades:</label>
                            <div id="editActividadesContainer" style="border: 1px solid #e2e8f0; border-radius: 5px; padding: 10px; min-height: 50px;">
                                ${proceso.actividades ? proceso.actividades.map(a => `<span class="multi-select-item">${a} <span class="remove" onclick="eliminarActividadEdit('${a}')">√ó</span></span>`).join('') : ''}
                            </div>
                            <div style="margin-top: 10px;">
                                <select id="editAgregarActividad" style="width: calc(100% - 80px); padding: 6px; border: 1px solid #e2e8f0; border-radius: 5px; margin-right: 10px;">
                                    <option value="">Seleccionar actividad...</option>
                                    ${actividades.map(a => `<option value="${a}">${a}</option>`).join('')}
                                </select>
                                <button onclick="agregarActividadEdit()" style="padding: 6px 12px; background: #3182ce; color: white; border: none; border-radius: 5px; cursor: pointer;">+</button>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Tiempo (min):</label>
                                <input type="number" id="editTiempoProceso" value="${proceso.tiempo}" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 5px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Frecuencia:</label>
                                <select id="editFrecuenciaProceso" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 5px;">
                                    <option value="Diario" ${proceso.frecuencia === 'Diario' ? 'selected' : ''}>Diario</option>
                                    <option value="Semanal" ${proceso.frecuencia === 'Semanal' ? 'selected' : ''}>Semanal</option>
                                    <option value="Mensual" ${proceso.frecuencia === 'Mensual' ? 'selected' : ''}>Mensual</option>
                                    <option value="Por demanda" ${proceso.frecuencia === 'Por demanda' ? 'selected' : ''}>Por demanda</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button onclick="guardarEdicionProceso(${index})" style="flex: 1; background: #38a169; color: white; border: none; border-radius: 8px; padding: 12px; cursor: pointer; font-weight: 600;">üíæ Guardar</button>
                            <button onclick="cerrarModalEditarProceso()" style="flex: 1; background: #e53e3e; color: white; border: none; border-radius: 8px; padding: 12px; cursor: pointer; font-weight: 600;">‚ùå Cancelar</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function eliminarSistemaEdit(sistema) {
            const container = document.getElementById('editSistemasContainer');
            const items = container.querySelectorAll('.multi-select-item');
            items.forEach(item => {
                if (item.textContent.includes(sistema)) {
                    item.remove();
                }
            });
        }

        function agregarSistemaEdit() {
            const select = document.getElementById('editAgregarSistema');
            const sistema = select.value;
            if (sistema) {
                const container = document.getElementById('editSistemasContainer');
                const span = document.createElement('span');
                span.className = 'multi-select-item';
                span.innerHTML = `${sistema} <span class="remove" onclick="eliminarSistemaEdit('${sistema}')">√ó</span>`;
                container.appendChild(span);
                select.value = '';
            }
        }

        function eliminarActividadEdit(actividad) {
            const container = document.getElementById('editActividadesContainer');
            const items = container.querySelectorAll('.multi-select-item');
            items.forEach(item => {
                if (item.textContent.includes(actividad)) {
                    item.remove();
                }
            });
        }

        function agregarActividadEdit() {
            const select = document.getElementById('editAgregarActividad');
            const actividad = select.value;
            if (actividad) {
                const container = document.getElementById('editActividadesContainer');
                const span = document.createElement('span');
                span.className = 'multi-select-item';
                span.innerHTML = `${actividad} <span class="remove" onclick="eliminarActividadEdit('${actividad}')">√ó</span>`;
                container.appendChild(span);
                select.value = '';
            }
        }

        function guardarEdicionProceso(index) {
            const procesoAnterior = {...procesos[index]};
            
            const sistemasEditados = [];
            document.querySelectorAll('#editSistemasContainer .multi-select-item').forEach(item => {
                const texto = item.textContent.replace('√ó', '').trim();
                if (texto) sistemasEditados.push(texto);
            });

            const actividadesEditadas = [];
            document.querySelectorAll('#editActividadesContainer .multi-select-item').forEach(item => {
                const texto = item.textContent.replace('√ó', '').trim();
                if (texto) actividadesEditadas.push(texto);
            });
            
            procesos[index] = {
                ...procesos[index],
                area: document.getElementById('editAreaProceso').value,
                puesto: document.getElementById('editPuestoProceso').value,
                descripcion: document.getElementById('editNombreProceso').value,
                sistemas: sistemasEditados,
                actividades: actividadesEditadas,
                tiempo: parseInt(document.getElementById('editTiempoProceso').value) || 0,
                frecuencia: document.getElementById('editFrecuenciaProceso').value,
                fechaModificacion: new Date().toISOString(),
                usuarioModificacion: usuarioActual.nombre
            };
            
            registrarCambio('proceso', 'modificar', `Proceso modificado: ${procesos[index].area} - ${procesos[index].descripcion}`, procesoAnterior, procesos[index]);
            
            mostrarVistaProcesosYFlujos();
            actualizarDashboard();
            generarDeteccionesAutomaticas();
            cerrarModalEditarProceso();
            mostrarAlerta('‚úÖ Proceso actualizado', 'success');
        }

        function cerrarModalEditarProceso() {
            const modal = document.getElementById('modalEditarProceso');
            if (modal) modal.remove();
        }

        function toggleActivoProceso(index) {
            const proceso = procesos[index];
            proceso.activo = !proceso.activo;
            proceso.fechaModificacion = new Date().toISOString();
            proceso.usuarioModificacion = usuarioActual.nombre;
            
            const estado = proceso.activo ? 'activado' : 'inactivado';
            registrarCambio('proceso', proceso.activo ? 'activar' : 'inactivar', 
                `Proceso ${estado}: ${proceso.area} - ${proceso.descripcion}`, null, proceso);
            
            mostrarVistaProcesosYFlujos();
            actualizarDashboard();
            generarDeteccionesAutomaticas();
            mostrarAlerta(`‚úÖ Proceso ${estado} correctamente`, 'success');
        }

        // Funciones de papelera
        function mostrarPapelera() {
            let html = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 15px; padding: 30px; max-width: 700px; max-height: 80vh; overflow-y: auto; width: 90%;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3>üóëÔ∏è Papelera de Reciclaje</h3>
                            <button onclick="cerrarPapelera()" style="background: #e53e3e; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer;">√ó</button>
                        </div>
                        <p style="color: #666; margin-bottom: 20px;">Los elementos se eliminan autom√°ticamente despu√©s de 30 d√≠as</p>
                        
                        <div style="margin-bottom: 20px;">
                            <button onclick="limpiarPapeleraCompleta()" style="background: #e53e3e; color: white; border: none; border-radius: 5px; padding: 8px 16px; cursor: pointer; font-weight: 600; margin-right: 10px;">üóëÔ∏è Vaciar Papelera</button>
                            <button onclick="restaurarTodosPapelera()" style="background: #38a169; color: white; border: none; border-radius: 5px; padding: 8px 16px; cursor: pointer; font-weight: 600;">‚Ü©Ô∏è Restaurar Todo</button>
                        </div>
            `;
            
            if (papelera.procesos.length > 0) {
                html += '<h4>üìã Procesos Eliminados</h4>';
                papelera.procesos.forEach((p, index) => {
                    const fecha = new Date(p.fechaEliminacion).toLocaleDateString();
                    const sistemasTexto = Array.isArray(p.sistemas) ? p.sistemas.join(', ') : p.sistemas;
                    html += `
                        <div style="border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin-bottom: 10px; background: #fef5e7;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div style="flex: 1;">
                                    <strong>${p.area} - ${p.descripcion}</strong><br>
                                    <small style="color: #666;">Sistemas: ${sistemasTexto} | Eliminado: ${fecha}</small>
                                    ${p.actividades && p.actividades.length > 0 ? `<br><small style="color: #666;">Actividades: ${p.actividades.join(', ')}</small>` : ''}
                                </div>
                                <div>
                                    <button onclick="restaurarProceso(${index})" style="background: #38a169; color: white; border: none; border-radius: 4px; padding: 6px 12px; cursor: pointer; font-size: 12px; margin-right: 5px;">‚Ü©Ô∏è Restaurar</button>
                                    <button onclick="eliminarPermanentemente('proceso', ${index})" style="background: #e53e3e; color: white; border: none; border-radius: 4px; padding: 6px 12px; cursor: pointer; font-size: 12px;">üóëÔ∏è Eliminar</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            if (papelera.procesos.length === 0) {
                html += '<p style="text-align: center; color: #666;">La papelera est√° vac√≠a</p>';
            }
            
            html += '</div></div>';
            
            const modal = document.createElement('div');
            modal.id = 'modalPapelera';
            modal.innerHTML = html;
            document.body.appendChild(modal);
        }

        function limpiarPapeleraCompleta() {
            if (confirm('¬øEst√°s seguro de vaciar completamente la papelera? Esta acci√≥n no se puede deshacer.')) {
                papelera.procesos = [];
                papelera.flujos = [];
                registrarCambio('sistema', 'eliminar', 'Papelera vaciada completamente', null, null);
                cerrarPapelera();
                mostrarAlerta('üóëÔ∏è Papelera vaciada completamente', 'alert');
            }
        }

        function restaurarTodosPapelera() {
            if (confirm('¬øRestaurar todos los elementos de la papelera?')) {
                papelera.procesos.forEach(proceso => {
                    delete proceso.fechaEliminacion;
                    procesos.push(proceso);
                });
                
                registrarCambio('sistema', 'restaurar', `${papelera.procesos.length} procesos restaurados desde papelera`, null, null);
                
                papelera.procesos = [];
                
                mostrarVistaProcesosYFlujos();
                actualizarDashboard();
                cerrarPapelera();
                mostrarAlerta('‚úÖ Todos los elementos restaurados', 'success');
            }
        }

        function eliminarPermanentemente(tipo, index) {
            if (confirm('¬øEliminar permanentemente este elemento? Esta acci√≥n no se puede deshacer.')) {
                if (tipo === 'proceso') {
                    const proceso = papelera.procesos[index];
                    registrarCambio('sistema', 'eliminar', `Proceso eliminado permanentemente: ${proceso.area} - ${proceso.descripcion}`, proceso, null);
                    papelera.procesos.splice(index, 1);
                }
                
                mostrarPapelera();
                mostrarAlerta('üóëÔ∏è Elemento eliminado permanentemente', 'alert');
            }
        }

        function restaurarProceso(index) {
            const proceso = papelera.procesos[index];
            delete proceso.fechaEliminacion;
            procesos.push(proceso);
            papelera.procesos.splice(index, 1);
            
            registrarCambio('proceso', 'restaurar', `Proceso restaurado desde papelera: ${proceso.area} - ${proceso.descripcion}`, null, proceso);
            
            mostrarVistaProcesosYFlujos();
            actualizarDashboard();
            mostrarPapelera();
            mostrarAlerta('‚úÖ Proceso restaurado', 'success');
        }

        function cerrarPapelera() {
            const modal = document.getElementById('modalPapelera');
            if (modal) modal.remove();
        }

        // Funciones de detecci√≥n autom√°tica
        function calcularSimilitudMejorada(texto1, texto2) {
            const t1 = texto1.toLowerCase().trim();
            const t2 = texto2.toLowerCase().trim();
            
            const palabras1 = t1.split(' ');
            const palabras2 = t2.split(' ');
            const interseccion = palabras1.filter(palabra => palabras2.includes(palabra));
            const similitudPalabras = Math.round((interseccion.length / Math.max(palabras1.length, palabras2.length)) * 100);
            
            const similitudCaracteres = calcularLevenshtein(t1, t2);
            
            return Math.max(similitudPalabras, similitudCaracteres);
        }

        function calcularLevenshtein(str1, str2) {
            const matrix = [];
            const len1 = str1.length;
            const len2 = str2.length;

            if (len1 === 0) return len2 === 0 ? 100 : 0;
            if (len2 === 0) return 0;

            for (let i = 0; i <= len1; i++) {
                matrix[i] = [i];
            }
            for (let j = 0; j <= len2; j++) {
                matrix[0][j] = j;
            }

            for (let i = 1; i <= len1; i++) {
                for (let j = 1; j <= len2; j++) {
                    if (str1.charAt(i - 1) === str2.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }

            const distance = matrix[len1][len2];
            const maxLength = Math.max(len1, len2);
            const similarity = ((maxLength - distance) / maxLength) * 100;
            
            return Math.round(similarity);
        }

        function detectarAutomaticamente() {
            const procesosActivos = procesos.filter(p => p.activo);
            let detecciones = [];
            
            // Detectar procesos similares
            for (let i = 0; i < procesosActivos.length; i++) {
                for (let j = i + 1; j < procesosActivos.length; j++) {
                    const similitud = calcularSimilitudMejorada(procesosActivos[i].descripcion, procesosActivos[j].descripcion);
                    if (similitud > 60) {
                        const deteccionId = `proceso_${procesosActivos[i].id}_${procesosActivos[j].id}`;
                        detecciones.push({
                            id: deteccionId,
                            tipo: 'proceso',
                            similitud: similitud,
                            proceso1: procesosActivos[i],
                            proceso2: procesosActivos[j],
                            metodo: similitud > 80 ? 'Alta similitud' : 'Similitud moderada',
                            responsable: deteccionesConResponsable.get(deteccionId) || null
                        });
                    }
                }
            }
            
            // Detectar sistemas redundantes
            const sistemasPorArea = {};
            procesosActivos.forEach(proceso => {
                if (!sistemasPorArea[proceso.area]) {
                    sistemasPorArea[proceso.area] = new Set();
                }
                if (proceso.sistemas) {
                    const sistemasArray = Array.isArray(proceso.sistemas) ? proceso.sistemas : [proceso.sistemas];
                    sistemasArray.forEach(sistema => {
                        sistemasPorArea[proceso.area].add(sistema);
                    });
                }
            });
            
            const sistemasRedundantes = {};
            Object.keys(sistemasPorArea).forEach(area => {
                sistemasPorArea[area].forEach(sistema => {
                    if (!sistemasRedundantes[sistema]) {
                        sistemasRedundantes[sistema] = [];
                    }
                    sistemasRedundantes[sistema].push(area);
                });
            });
            
            Object.keys(sistemasRedundantes).forEach(sistema => {
                if (sistemasRedundantes[sistema].length > 1) {
                    const procesosConSistema = procesosActivos.filter(p => {
                        if (Array.isArray(p.sistemas)) {
                            return p.sistemas.includes(sistema);
                        }
                        return p.sistemas && p.sistemas.includes(sistema);
                    });
                    const deteccionId = `sistema_${sistema}`;
                    detecciones.push({
                        id: deteccionId,
                        tipo: 'sistema',
                        sistema: sistema,
                        areas: sistemasRedundantes[sistema],
                        procesos: procesosConSistema,
                        responsable: deteccionesConResponsable.get(deteccionId) || null
                    });
                }
            });
            
            // Detectar actividades en m√∫ltiples sistemas
            const actividadesPorSistema = {};
            procesosActivos.forEach(proceso => {
                if (proceso.actividades && proceso.sistemas) {
                    const sistemasArray = Array.isArray(proceso.sistemas) ? proceso.sistemas : [proceso.sistemas];
                    proceso.actividades.forEach(actividad => {
                        if (!actividadesPorSistema[actividad]) {
                            actividadesPorSistema[actividad] = new Set();
                        }
                        sistemasArray.forEach(sistema => {
                            actividadesPorSistema[actividad].add(sistema);
                        });
                    });
                }
            });
            
            Object.keys(actividadesPorSistema).forEach(actividad => {
                if (actividadesPorSistema[actividad].size > 1) {
                    const sistemasArray = Array.from(actividadesPorSistema[actividad]);
                    const procesosConActividad = procesosActivos.filter(p => 
                        p.actividades && p.actividades.includes(actividad)
                    );
                    const deteccionId = `actividad_${actividad}`;
                    
                    detecciones.push({
                        id: deteccionId,
                        tipo: 'actividadSistema',
                        actividad: actividad,
                        sistemas: sistemasArray,
                        procesos: procesosConActividad,
                        responsable: deteccionesConResponsable.get(deteccionId) || null
                    });
                }
            });
            
            duplicidadesDetectadas = detecciones.filter(d => d.tipo === 'proceso' || d.tipo === 'sistema');
            
            return detecciones;
        }

        function asignarResponsable(deteccionId, descripcion) {
            const responsable = prompt('Asignar responsable a esta detecci√≥n:', '');
            if (responsable && responsable.trim()) {
                deteccionesConResponsable.set(deteccionId, responsable.trim());
                
                const nuevaAccion = {
                    id: Date.now(),
                    tipo: 'Eliminaci√≥n de Duplicidad',
                    estado: 'Planificada',
                    descripcion: descripcion,
                    duplicidadAbordada: deteccionId,
                    accionesTomadas: 'Asignaci√≥n inicial de responsable',
                    responsable: responsable.trim(),
                    fechaObjetivo: '',
                    ahorroEstimado: 0,
                    moneda: 'MXN',
                    fechaCreacion: new Date().toISOString(),
                    usuarioCreacion: usuarioActual.nombre,
                    fechaCompletado: null
                };
                
                accionesMejora.push(nuevaAccion);
                
                registrarCambio('sistema', 'crear', `Responsable asignado y acci√≥n registrada: ${descripcion}`, null, nuevaAccion);
                
                generarDeteccionesAutomaticas();
                mostrarAlerta('‚úÖ Responsable asignado y acci√≥n registrada autom√°ticamente', 'success');
            }
        }

        function generarDeteccionesAutomaticas() {
            const detecciones = detectarAutomaticamente();
            
            const filtro = document.getElementById('filtroDeteccionesAutomaticas')?.value || '';
            
            const alertasContainer = document.getElementById('alertasAutomaticas');
            if (!alertasContainer) return;
            
            alertasContainer.innerHTML = '';
            
            const procesosDuplicados = detecciones.filter(d => d.tipo === 'proceso');
            const procesosFiltrados = procesosDuplicados.filter(det => {
                if (filtro === 'asignado') return det.responsable;
                if (filtro === 'sin-asignar') return !det.responsable;
                return true;
            });
            
            if (procesosFiltrados.length > 0) {
                procesosFiltrados.forEach(det => {
                    const claseResponsable = det.responsable ? 'deteccion-con-responsable' : 'deteccion-sin-responsable';
                    const div = document.createElement('div');
                    div.className = `alert ${claseResponsable}`;
                    div.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <strong>‚ö†Ô∏è DUPLICIDAD DETECTADA (${det.metodo}):</strong><br>
                                <strong>${det.proceso1.area}: "${det.proceso1.descripcion}"</strong> ‚Üî <strong>${det.proceso2.area}: "${det.proceso2.descripcion}"</strong><br>
                                <em>Similitud: ${det.similitud}% - Algoritmo: ${det.similitud > 80 ? 'Palabras + Caracteres' : det.similitud > 60 ? 'Detecci√≥n por caracteres' : 'Detecci√≥n por palabras'}</em><br>
                                üí∞ <strong>Costo estimado:</strong> ~$500-1,500/mes en tiempo duplicado<br>
                                üéØ <strong>Recomendaci√≥n:</strong> Centralizar en una sola √°rea
                                ${det.responsable ? `<br><div class="responsable-asignado">üë§ Responsable: ${det.responsable}</div>` : ''}
                            </div>
                            <div>
                                ${!det.responsable ? `<button class="btn-asignar" onclick="asignarResponsable('${det.id}', 'Duplicidad: ${det.proceso1.descripcion} vs ${det.proceso2.descripcion}')">üë§ Asignar</button>` : ''}
                            </div>
                        </div>
                    `;
                    alertasContainer.appendChild(div);
                });
            }
            
            const sistemasRedundantes = detecciones.filter(d => d.tipo === 'sistema');
            const sistemasFiltrados = sistemasRedundantes.filter(det => {
                if (filtro === 'asignado') return det.responsable;
                if (filtro === 'sin-asignar') return !det.responsable;
                return true;
            });

            sistemasFiltrados.forEach(det => {
                const claseResponsable = det.responsable ? 'deteccion-con-responsable' : 'deteccion-sin-responsable';
                const div = document.createElement('div');
                div.className = `alert ${claseResponsable}`;
                
                let detalleUsos = '';
                det.areas.forEach(area => {
                    const procesosEnArea = det.procesos.filter(p => p.area === area).map(p => p.descripcion);
                    detalleUsos += `<br>&nbsp;&nbsp;‚Ä¢ <strong>${area}:</strong> ${procesosEnArea.join(', ')}`;
                });
                
                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <strong>üîß SISTEMA REDUNDANTE:</strong><br>
                            El sistema <strong>${det.sistema}</strong> se usa en m√∫ltiples √°reas:${detalleUsos}<br>
                            üéØ <strong>Recomendaci√≥n:</strong> Integrar uso del sistema o estandarizar procesos
                            ${det.responsable ? `<br><div class="responsable-asignado">üë§ Responsable: ${det.responsable}</div>` : ''}
                        </div>
                        <div>
                            ${!det.responsable ? `<button class="btn-asignar" onclick="asignarResponsable('${det.id}', 'Sistema redundante: ${det.sistema}')">üë§ Asignar</button>` : ''}
                        </div>
                    </div>
                `;
                alertasContainer.appendChild(div);
            });
            
            if (procesosFiltrados.length === 0 && sistemasFiltrados.length === 0) {
                if (filtro) {
                    alertasContainer.innerHTML = `<div class="alert">‚ÑπÔ∏è No hay detecciones ${filtro === 'asignado' ? 'con responsable asignado' : 'sin responsable asignado'}</div>`;
                } else {
                    alertasContainer.innerHTML = '<div class="alert success">‚úÖ No se detectaron problemas graves en los procesos actuales</div>';
                }
            }
            
            mostrarActividadesSistemas(detecciones);
            actualizarOportunidades();
            generarPlanDeAccion();
        }

        function mostrarActividadesSistemas(detecciones) {
            const filtro = document.getElementById('filtroActividadesSistemas')?.value || '';
            const actividadesSistemasContainer = document.getElementById('actividadesSistemas');
            if (!actividadesSistemasContainer) return;
            
            actividadesSistemasContainer.innerHTML = '';
            
            const actividadesSistemas = detecciones.filter(d => d.tipo === 'actividadSistema');
            const actividadesFiltradas = actividadesSistemas.filter(det => {
                if (filtro === 'asignado') return det.responsable;
                if (filtro === 'sin-asignar') return !det.responsable;
                return true;
            });
            
            if (actividadesFiltradas.length > 0) {
                actividadesFiltradas.forEach(det => {
                    const claseResponsable = det.responsable ? 'deteccion-con-responsable' : 'deteccion-sin-responsable';
                    const div = document.createElement('div');
                    div.className = `alert ${claseResponsable}`;
                    div.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <strong>üîÑ ACTIVIDAD EN M√öLTIPLES SISTEMAS:</strong><br>
                                <strong>${det.actividad}</strong> se realiza usando diferentes sistemas:<br>
                                ${det.sistemas.map(sistema => `&nbsp;&nbsp;‚Ä¢ ${sistema}`).join('<br>')}<br>
                                <strong>Procesos afectados:</strong><br>
                                ${det.procesos.map(p => `&nbsp;&nbsp;‚Ä¢ ${p.area}: ${p.descripcion} (${Array.isArray(p.sistemas) ? p.sistemas.join(', ') : p.sistemas})`).join('<br>')}<br>
                                üí∞ <strong>Impacto:</strong> Posible redundancia en sistemas para la misma actividad<br>
                                üéØ <strong>Recomendaci√≥n:</strong> Estandarizar sistema √∫nico para esta actividad
                                ${det.responsable ? `<br><div class="responsable-asignado">üë§ Responsable: ${det.responsable}</div>` : ''}
                            </div>
                            <div>
                                ${!det.responsable ? `<button class="btn-asignar" onclick="asignarResponsable('${det.id}', 'Actividad en m√∫ltiples sistemas: ${det.actividad}')">üë§ Asignar</button>` : ''}
                            </div>
                        </div>
                    `;
                    actividadesSistemasContainer.appendChild(div);
                });
            } else {
                if (filtro) {
                    actividadesSistemasContainer.innerHTML = `<div class="alert">‚ÑπÔ∏è No hay actividades en sistemas ${filtro === 'asignado' ? 'con responsable asignado' : 'sin responsable asignado'}</div>`;
                } else {
                    actividadesSistemasContainer.innerHTML = '<div class="alert success">‚úÖ No se detectaron actividades redundantes en m√∫ltiples sistemas</div>';
                }
            }
        }

        function filtrarDeteccionesAutomaticas() {
            generarDeteccionesAutomaticas();
        }

        function filtrarActividadesSistemas() {
            const detecciones = detectarAutomaticamente();
            mostrarActividadesSistemas(detecciones);
        }

        function filtrarDetecciones() {
            generarDeteccionesAutomaticas();
        }

        // Funciones de oportunidades y an√°lisis de costos
        function actualizarOportunidades() {
            const procesosSimilares = procesos.filter(p => p.activo);
            let horasSemanaDuplicidades = 0;
            let duplicidades = 0;
            
            for (let i = 0; i < procesosSimilares.length; i++) {
                for (let j = i + 1; j < procesosSimilares.length; j++) {
                    const similitud = calcularSimilitudMejorada(procesosSimilares[i].descripcion, procesosSimilares[j].descripcion);
                    if (similitud > 60) {
                        duplicidades++;
                        let frecSem1 = getFrecuenciaSemanal(procesosSimilares[i].frecuencia);
                        let frecSem2 = getFrecuenciaSemanal(procesosSimilares[j].frecuencia);
                        
                        let tiempoDuplicado = Math.min(procesosSimilares[i].tiempo * frecSem1, procesosSimilares[j].tiempo * frecSem2);
                        horasSemanaDuplicidades += tiempoDuplicado / 60;
                    }
                }
            }
            
            const tiempoTotalElement = document.getElementById('tiempoTotal');
            if (tiempoTotalElement) {
                tiempoTotalElement.textContent = Math.round(horasSemanaDuplicidades * 10) / 10;
            }
            
            const costoMensualEstimado = horasSemanaDuplicidades * 20 * 4.3;
            const costoEstimadoElement = document.getElementById('costoEstimado');
            if (costoEstimadoElement) {
                costoEstimadoElement.textContent = `${Math.round(costoMensualEstimado).toLocaleString()}`;
            }
            
            const sistemasRedundantes = detectarSistemasRedundantes();
            const sistemasElement = document.getElementById('sistemas');
            if (sistemasElement) {
                sistemasElement.textContent = Object.keys(sistemasRedundantes).length;
            }
        }

        function detectarSistemasRedundantes() {
            const sistemasUso = {};
            
            procesos.filter(p => p.activo).forEach(p => {
                if (p.sistemas) {
                    const sistemasArray = Array.isArray(p.sistemas) ? p.sistemas : [p.sistemas];
                    sistemasArray.forEach(sistema => {
                        if (!sistemasUso[sistema]) {
                            sistemasUso[sistema] = [];
                        }
                        sistemasUso[sistema].push({
                            area: p.area,
                            proceso: p.descripcion
                        });
                    });
                }
            });
            
            const sistemasRedundantes = {};
            Object.keys(sistemasUso).forEach(sistema => {
                const areas = [...new Set(sistemasUso[sistema].map(u => u.area))];
                if (areas.length > 1) {
                    sistemasRedundantes[sistema] = sistemasUso[sistema];
                }
            });
            
            return sistemasRedundantes;
        }

        function getFrecuenciaSemanal(frecuencia) {
            switch(frecuencia) {
                case 'Diario': return 5;
                case 'Semanal': return 1;
                case 'Mensual': return 0.25;
                case 'Por demanda': return 2;
                default: return 1;
            }
        }

        function generarPlanDeAccion() {
            const recomendaciones = document.getElementById('recomendaciones');
            if (!recomendaciones) return;
            
            const detecciones = detectarAutomaticamente();
            
            const procesosSimilares = detecciones.filter(d => d.tipo === 'proceso');
            const sistemasRedundantes = detecciones.filter(d => d.tipo === 'sistema');
            
            let html = '';
            let prioridad = 1;
            
            if (procesosSimilares.length > 0) {
                html += `
                    <div class="alert">
                        <strong>üéØ PRIORIDAD ${prioridad++}: Eliminar Duplicidades de Procesos</strong><br>
                        <strong>Acciones inmediatas:</strong><br>
                        ‚Ä¢ Reunir a responsables de √°reas con procesos duplicados<br>
                        ‚Ä¢ Definir √°rea √∫nica responsable para cada proceso<br>
                        ‚Ä¢ Establecer protocolo de comunicaci√≥n entre √°reas<br>
                        <strong>Ahorro estimado:</strong> ${Math.round((procesosSimilares.length * 750 + procesosSimilares.length * 1000) / 2).toLocaleString()}/mes
                    </div>
                `;
            }
            
            if (sistemasRedundantes.length > 0) {
                html += `
                    <div class="alert">
                        <strong>üéØ PRIORIDAD ${prioridad++}: Integrar Sistemas Redundantes</strong><br>
                        <strong>Acciones inmediatas:</strong><br>
                        ‚Ä¢ Auditar uso actual de sistemas redundantes<br>
                        ‚Ä¢ Evaluar integraci√≥n vs. estandarizaci√≥n<br>
                        ‚Ä¢ Capacitar a usuarios en sistema unificado<br>
                        <strong>Ahorro estimado:</strong> ${(sistemasRedundantes.length * 300).toLocaleString()}/mes en licencias
                    </div>
                `;
            }
            
            if (procesosSimilares.length > 0 || sistemasRedundantes.length > 0) {
                html += `
                    <div class="alert success">
                        <strong>üìã SIGUIENTE FASE: Implementaci√≥n y Seguimiento</strong><br>
                        ‚Ä¢ Establecer m√©tricas de seguimiento<br>
                        ‚Ä¢ Revisar progreso cada 2 semanas<br>
                        ‚Ä¢ Documentar procesos optimizados<br>
                        ‚Ä¢ Capacitar al equipo en nuevos procesos
                    </div>
                `;
            } else {
                html += `
                    <div class="alert success">
                        <strong>üéâ ¬°Excelente! No se detectaron problemas cr√≠ticos</strong><br>
                        <strong>Acciones de mantenimiento:</strong><br>
                        ‚Ä¢ Revisar procesos trimestralmente<br>
                        ‚Ä¢ Mantener documentaci√≥n actualizada<br>
                        ‚Ä¢ Buscar oportunidades de mejora continua<br>
                        ‚Ä¢ Evaluar nuevas tecnolog√≠as disponibles
                    </div>
                `;
            }
            
            recomendaciones.innerHTML = html;
        }

        // Funciones de acciones de mejora
        function mostrarAccionesMejora() {
            const filtroEstado = document.getElementById('filtroEstadoAcciones')?.value || '';
            const filtroTipo = document.getElementById('filtroTipoAcciones')?.value || '';
            const filtroResponsable = document.getElementById('filtroResponsableAcciones')?.value.toLowerCase() || '';
            
            let accionesFiltradas = accionesMejora.filter(accion => {
                const cumpleEstado = !filtroEstado || accion.estado === filtroEstado;
                const cumpleTipo = !filtroTipo || accion.tipo === filtroTipo;
                const cumpleResponsable = !filtroResponsable || accion.responsable.toLowerCase().includes(filtroResponsable);
                
                return cumpleEstado && cumpleTipo && cumpleResponsable;
            });
            
            const container = document.getElementById('listaAcciones');
            if (!container) return;
            
            if (accionesFiltradas.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No hay acciones que coincidan con los filtros</p>';
                return;
            }
            
            let html = '';
            accionesFiltradas.forEach((accion, index) => {
                const realIndex = accionesMejora.indexOf(accion);
                const fecha = new Date(accion.fechaCreacion).toLocaleDateString();
                const fechaObjetivo = accion.fechaObjetivo ? new Date(accion.fechaObjetivo).toLocaleDateString() : 'No definida';
                const estadoColor = accion.estado === 'Completada' ? '#38a169' : 
                                   accion.estado === 'En Progreso' ? '#3182ce' : 
                                   accion.estado === 'Cancelada' ? '#e53e3e' : '#f59e0b';
                
                html += `
                    <div class="cambio-item">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div style="flex: 1;">
                                <span style="background: ${estadoColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-right: 10px;">${accion.estado}</span>
                                <strong>${accion.tipo}</strong>
                                ${accion.duplicidadAbordada ? `<span style="background: #e3f2fd; color: #1976d2; padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-left: 5px;">üîó Relacionada</span>` : ''}
                            </div>
                            <div>
                                <button onclick="editarAccion(${realIndex})" style="background: #3182ce; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer; font-size: 12px; margin-right: 5px;">Editar</button>
                                <button onclick="eliminarAccion(${realIndex})" style="background: #e53e3e; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer; font-size: 12px;">Eliminar</button>
                            </div>
                        </div>
                        <p style="margin-bottom: 8px;"><strong>Descripci√≥n:</strong> ${accion.descripcion}</p>
                        ${accion.accionesTomadas ? `<p style="margin-bottom: 8px;"><strong>Acciones Tomadas:</strong> ${accion.accionesTomadas}</p>` : ''}
                        <p style="color: #666; margin-bottom: 5px;"><strong>Responsable:</strong> ${accion.responsable} | <strong>Ahorro estimado:</strong> ${accion.ahorroEstimado.toLocaleString()} ${accion.moneda || 'MXN'}</p>
                        <p style="color: #666; margin-bottom: 5px;"><strong>Fecha objetivo:</strong> ${fechaObjetivo} | <strong>Registrada:</strong> ${fecha}</p>
                        <p style="color: #666;"><strong>Por:</strong> ${accion.usuarioCreacion}</p>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function registrarAccion() {
            const tipo = document.getElementById('tipoAccion').value;
            const estado = document.getElementById('estadoAccion').value;
            const descripcion = document.getElementById('descripcionAccion').value.trim();
            const duplicidadAbordada = document.getElementById('duplicidadAbordada').value;
            const accionesTomadas = document.getElementById('accionesTomadas').value.trim();
            const responsable = document.getElementById('responsableAccion').value.trim();
            const fechaObjetivo = document.getElementById('fechaObjetivo').value;
            const ahorro = parseFloat(document.getElementById('ahorroEstimado').value) || 0;
            const moneda = document.getElementById('monedaAhorro').value;
            
            if (descripcion && responsable) {
                const nuevaAccion = {
                    id: Date.now(),
                    tipo: tipo,
                    estado: estado,
                    descripcion: descripcion,
                    duplicidadAbordada: duplicidadAbordada,
                    accionesTomadas: accionesTomadas,
                    responsable: responsable,
                    fechaObjetivo: fechaObjetivo,
                    ahorroEstimado: ahorro,
                    moneda: moneda,
                    fechaCreacion: new Date().toISOString(),
                    usuarioCreacion: usuarioActual.nombre,
                    fechaCompletado: estado === 'Completada' ? new Date().toISOString() : null
                };
                
                accionesMejora.push(nuevaAccion);
                
                registrarCambio('sistema', 'crear', `Nueva acci√≥n de mejora registrada: ${descripcion}`, null, nuevaAccion);
                
                limpiarFormularioAcciones();
                mostrarAccionesMejora();
                actualizarDashboard();
                mostrarAlerta('‚úÖ Acci√≥n de mejora registrada', 'success');
            } else {
                mostrarAlerta('‚ùå Descripci√≥n y responsable son requeridos', 'alert');
            }
        }

        function limpiarFormularioAcciones() {
            document.getElementById('tipoAccion').value = 'Eliminaci√≥n de Duplicidad';
            document.getElementById('estadoAccion').value = 'Planificada';
            document.getElementById('descripcionAccion').value = '';
            document.getElementById('duplicidadAbordada').value = '';
            document.getElementById('accionesTomadas').value = '';
            document.getElementById('responsableAccion').value = '';
            document.getElementById('fechaObjetivo').value = '';
            document.getElementById('ahorroEstimado').value = '';
            document.getElementById('monedaAhorro').value = 'MXN';
        }

        function actualizarDuplicidadesEnSelect() {
            const select = document.getElementById('duplicidadAbordada');
            if (!select) return;
            
            select.innerHTML = '<option value="">No relacionado con duplicidad espec√≠fica</option>';
            
            const detecciones = detectarAutomaticamente();
            
            const procesosDuplicados = detecciones.filter(d => d.tipo === 'proceso');
            procesosDuplicados.forEach(det => {
                const option = document.createElement('option');
                option.value = det.id;
                option.textContent = `Duplicidad de Proceso: ${det.proceso1.descripcion} vs ${det.proceso2.descripcion} (${det.similitud}% similitud)`;
                select.appendChild(option);
            });
            
            const sistemasRedundantes = detecciones.filter(d => d.tipo === 'sistema');
            sistemasRedundantes.forEach(det => {
                const option = document.createElement('option');
                option.value = det.id;
                option.textContent = `Sistema Redundante: ${det.sistema} usado en ${det.areas.length} √°reas (${det.areas.join(', ')})`;
                select.appendChild(option);
            });
            
            const actividadesSistemas = detecciones.filter(d => d.tipo === 'actividadSistema');
            actividadesSistemas.forEach(det => {
                const option = document.createElement('option');
                option.value = det.id;
                option.textContent = `Actividad Multi-Sistema: "${det.actividad}" en ${det.sistemas.length} sistemas (${det.sistemas.join(', ')})`;
                select.appendChild(option);
            });
            
            duplicidadesDetectadas = [...procesosDuplicados, ...sistemasRedundantes, ...actividadesSistemas];
        }

        function editarAccion(index) {
            const accion = accionesMejora[index];
            const modal = document.createElement('div');
            modal.id = 'modalEditarAccion';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 15px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <h3 style="margin-bottom: 20px;">‚úèÔ∏è Editar Acci√≥n de Mejora</h3>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Tipo de Acci√≥n:</label>
                                <select id="editTipoAccion" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 5px;">
                                    <option value="Eliminaci√≥n de Duplicidad" ${accion.tipo === 'Eliminaci√≥n de Duplicidad' ? 'selected' : ''}>Eliminaci√≥n de Duplicidad</option>
                                    <option value="Integraci√≥n de Sistemas" ${accion.tipo === 'Integraci√≥n de Sistemas' ? 'selected' : ''}>Integraci√≥n de Sistemas</option>
                                    <option value="Optimizaci√≥n de Proceso" ${accion.tipo === 'Optimizaci√≥n de Proceso' ? 'selected' : ''}>Optimizaci√≥n de Proceso</option>
                                    <option value="Capacitaci√≥n" ${accion.tipo === 'Capacitaci√≥n' ? 'selected' : ''}>Capacitaci√≥n</option>
                                    <option value="Reorganizaci√≥n" ${accion.tipo === 'Reorganizaci√≥n' ? 'selected' : ''}>Reorganizaci√≥n</option>
                                    <option value="Automatizaci√≥n" ${accion.tipo === 'Automatizaci√≥n' ? 'selected' : ''}>Automatizaci√≥n</option>
                                    <option value="Otro" ${accion.tipo === 'Otro' ? 'selected' : ''}>Otro</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Estado:</label>
                                <select id="editEstadoAccion" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 5px;">
                                    <option value="Planificada" ${accion.estado === 'Planificada' ? 'selected' : ''}>Planificada</option>
                                    <option value="En Progreso" ${accion.estado === 'En Progreso' ? 'selected' : ''}>En Progreso</option>
                                    <option value="Completada" ${accion.estado === 'Completada' ? 'selected' : ''}>Completada</option>
                                    <option value="Cancelada" ${accion.estado === 'Cancelada' ? 'selected' : ''}>Cancelada</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Descripci√≥n:</label>
                            <textarea id="editDescripcionAccion" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 5px; min-height: 60px;">${accion.descripcion}</textarea>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Acciones Espec√≠ficas Tomadas:</label>
                            <textarea id="editAccionesTomadas" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 5px; min-height: 60px;">${accion.accionesTomadas || ''}</textarea>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Responsable:</label>
                                <input type="text" id="editResponsableAccion" value="${accion.responsable}" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 5px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Fecha Objetivo:</label>
                                <input type="date" id="editFechaObjetivo" value="${accion.fechaObjetivo}" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 5px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Ahorro Estimado:</label>
                                <div style="display: flex; gap: 5px;">
                                    <input type="number" id="editAhorroEstimado" value="${accion.ahorroEstimado}" style="flex: 1; padding: 8px; border: 1px solid #e2e8f0; border-radius: 5px;">
                                    <select id="editMonedaAhorro" style="width: 80px; padding: 8px; border: 1px solid #e2e8f0; border-radius: 5px;">
                                        <option value="MXN" ${(accion.moneda || 'MXN') === 'MXN' ? 'selected' : ''}>MXN</option>
                                        <option value="USD" ${accion.moneda === 'USD' ? 'selected' : ''}>USD</option>
                                        <option value="EUR" ${accion.moneda === 'EUR' ? 'selected' : ''}>EUR</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button onclick="guardarEdicionAccion(${index})" style="flex: 1; background: #38a169; color: white; border: none; border-radius: 8px; padding: 12px; cursor: pointer; font-weight: 600;">üíæ Guardar</button>
                            <button onclick="cerrarModalEditarAccion()" style="flex: 1; background: #e53e3e; color: white; border: none; border-radius: 8px; padding: 12px; cursor: pointer; font-weight: 600;">‚ùå Cancelar</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function guardarEdicionAccion(index) {
            const accionAnterior = {...accionesMejora[index]};
            
            accionesMejora[index] = {
                ...accionesMejora[index],
                tipo: document.getElementById('editTipoAccion').value,
                estado: document.getElementById('editEstadoAccion').value,
                descripcion: document.getElementById('editDescripcionAccion').value,
                accionesTomadas: document.getElementById('editAccionesTomadas').value,
                responsable: document.getElementById('editResponsableAccion').value,
                fechaObjetivo: document.getElementById('editFechaObjetivo').value,
                ahorroEstimado: parseFloat(document.getElementById('editAhorroEstimado').value) || 0,
                moneda: document.getElementById('editMonedaAhorro').value,
                fechaModificacion: new Date().toISOString(),
                usuarioModificacion: usuarioActual.nombre
            };
            
            if (accionesMejora[index].estado === 'Completada' && accionAnterior.estado !== 'Completada') {
                accionesMejora[index].fechaCompletado = new Date().toISOString();
            }
            
            registrarCambio('sistema', 'modificar', `Acci√≥n de mejora modificada: ${accionesMejora[index].descripcion}`, accionAnterior, accionesMejora[index]);
            
            mostrarAccionesMejora();
            actualizarDashboard();
            cerrarModalEditarAccion();
            mostrarAlerta('‚úÖ Acci√≥n actualizada', 'success');
        }

        function cerrarModalEditarAccion() {
            const modal = document.getElementById('modalEditarAccion');
            if (modal) modal.remove();
        }

        function eliminarAccion(index) {
            if (confirm('¬øEliminar esta acci√≥n de mejora?')) {
                const accion = accionesMejora[index];
                
                registrarCambio('sistema', 'eliminar', `Acci√≥n de mejora eliminada: ${accion.descripcion}`, accion, null);
                
                accionesMejora.splice(index, 1);
                mostrarAccionesMejora();
                actualizarDashboard();
                mostrarAlerta('üóëÔ∏è Acci√≥n eliminada', 'alert');
            }
        }

        function filtrarAcciones() {
            mostrarAccionesMejora();
        }

        // Funciones de gesti√≥n de usuarios
        function mostrarGestionUsuarios() {
            actualizarSelectsUsuarios();
            mostrarListaUsuarios();
        }

        function actualizarSelectsUsuarios() {
            const areaUsuarioSelect = document.getElementById('areaUsuario');
            if (areaUsuarioSelect) {
                areaUsuarioSelect.innerHTML = '<option value="">Todas las √°reas</option>';
                areas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area;
                    option.textContent = area;
                    areaUsuarioSelect.appendChild(option);
                });
            }
        }

        function crearUsuario() {
            const nombre = document.getElementById('nombreUsuario').value.trim();
            const email = document.getElementById('emailUsuario').value.trim();
            const rol = document.getElementById('rolUsuario').value;
            const area = document.getElementById('areaUsuario').value;
            const estado = document.getElementById('estadoUsuario').value;
            
            if (nombre && email) {
                const nuevoUsuario = {
                    id: Date.now(),
                    nombre: nombre,
                    email: email,
                    rol: rol,
                    area: area,
                    estado: estado,
                    fechaCreacion: new Date().toISOString(),
                    ultimaSesion: null,
                    passwordTemporal: generarPasswordTemporal()
                };
                
                usuarios.push(nuevoUsuario);
                
                registrarCambio('usuario', 'crear', `Nuevo usuario creado: ${nombre} (${email})`, null, nuevoUsuario);
                
                limpiarFormularioUsuarios();
                mostrarListaUsuarios();
                mostrarAlerta(`‚úÖ Usuario creado. Password temporal: ${nuevoUsuario.passwordTemporal}`, 'success');
            } else {
                mostrarAlerta('‚ùå Nombre y email son requeridos', 'alert');
            }
        }

        function limpiarFormularioUsuarios() {
            document.getElementById('nombreUsuario').value = '';
            document.getElementById('emailUsuario').value = '';
            document.getElementById('rolUsuario').value = 'Consulta';
            document.getElementById('areaUsuario').value = '';
            document.getElementById('estadoUsuario').value = 'Activo';
        }

        function generarPasswordTemporal() {
            return Math.random().toString(36).slice(-8).toUpperCase();
        }

        function mostrarListaUsuarios() {
            const container = document.getElementById('listaUsuarios');
            if (!container) return;
            
            if (usuarios.length <= 1) {
                container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">Solo hay un usuario registrado (actual)</p>';
                return;
            }
            
            let html = '';
            usuarios.forEach((usuario, index) => {
                const fechaCreacion = new Date(usuario.fechaCreacion).toLocaleDateString();
                const ultimaSesion = usuario.ultimaSesion ? new Date(usuario.ultimaSesion).toLocaleDateString() : 'Nunca';
                const esActual = usuario.id === usuarioActual.id;
                
                html += `
                    <div style="border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin-bottom: 10px; background: ${usuario.estado === 'Activo' ? '#f7fafc' : '#fdf2f8'};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <strong>${usuario.nombre}</strong> ${esActual ? '<span style="background: #e3f2fd; color: #1976d2; padding: 2px 6px; border-radius: 10px; font-size: 10px;">ACTUAL</span>' : ''}
                                <br><span style="color: #666; font-size: 14px;">${usuario.email}</span>
                            </div>
                            <div>
                                ${!esActual ? `<button onclick="toggleEstadoUsuario(${index})" style="background: ${usuario.estado === 'Activo' ? '#f56565' : '#38a169'}; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer; font-size: 12px; margin-right: 5px;">${usuario.estado === 'Activo' ? 'Inactivar' : 'Activar'}</button>` : ''}
                                ${!esActual ? `<button onclick="eliminarUsuario(${index})" style="background: #e53e3e; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer; font-size: 12px;">Eliminar</button>` : ''}
                            </div>
                        </div>
                        <p style="color: #666; margin-bottom: 5px;"><strong>Rol:</strong> ${usuario.rol} | <strong>√Årea:</strong> ${usuario.area || 'Todas'}</p>
                        <p style="color: #666; margin-bottom: 5px;"><strong>Estado:</strong> ${usuario.estado} | <strong>Creado:</strong> ${fechaCreacion}</p>
                        <p style="color: #666;"><strong>√öltima sesi√≥n:</strong> ${ultimaSesion}</p>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function toggleEstadoUsuario(index) {
            const usuario = usuarios[index];
            usuario.estado = usuario.estado === 'Activo' ? 'Inactivo' : 'Activo';
            
            registrarCambio('usuario', usuario.estado === 'Activo' ? 'activar' : 'inactivar', 
                `Usuario ${usuario.estado === 'Activo' ? 'activado' : 'inactivado'}: ${usuario.nombre}`, null, usuario);
            
            mostrarListaUsuarios();
            mostrarAlerta(`‚úÖ Usuario ${usuario.estado === 'Activo' ? 'activado' : 'inactivado'}`, 'success');
        }

        function eliminarUsuario(index) {
            const usuario = usuarios[index];
            if (confirm(`¬øEliminar el usuario ${usuario.nombre}?`)) {
                registrarCambio('usuario', 'eliminar', `Usuario eliminado: ${usuario.nombre}`, usuario, null);
                
                usuarios.splice(index, 1);
                mostrarListaUsuarios();
                mostrarAlerta('üóëÔ∏è Usuario eliminado', 'alert');
            }
        }

        // Funciones de auditor√≠a
        function mostrarAuditoria() {
            actualizarEstadisticasAuditoria();
            filtrarAuditoria();
        }

        function actualizarEstadisticasAuditoria() {
            const totalCambios = auditoria.length;
            const hoy = new Date().toDateString();
            const cambiosHoy = auditoria.filter(c => new Date(c.fecha).toDateString() === hoy).length;
            const usuariosActivos = new Set(auditoria.map(c => c.usuario)).size;
            
            document.getElementById('totalCambios').textContent = totalCambios;
            document.getElementById('cambiosHoy').textContent = cambiosHoy;
            document.getElementById('usuariosActivos').textContent = usuariosActivos;
            
            const filtroUsuario = document.getElementById('filtroUsuarioAuditoria');
            if (filtroUsuario) {
                const usuarioSeleccionado = filtroUsuario.value;
                filtroUsuario.innerHTML = '<option value="">Todos</option>';
                [...new Set(auditoria.map(c => c.usuario))].forEach(usuario => {
                    const option = document.createElement('option');
                    option.value = usuario;
                    option.textContent = usuario;
                    if (usuario === usuarioSeleccionado) option.selected = true;
                    filtroUsuario.appendChild(option);
                });
            }
        }

        function filtrarAuditoria() {
            const filtroTipo = document.getElementById('filtroTipoAuditoria')?.value || '';
            const filtroUsuario = document.getElementById('filtroUsuarioAuditoria')?.value || '';
            const fechaDesde = document.getElementById('fechaDesdeAuditoria')?.value || '';
            const fechaHasta = document.getElementById('fechaHastaAuditoria')?.value || '';
            
            let auditoriaFiltrada = auditoria.filter(cambio => {
                const cumpleTipo = !filtroTipo || cambio.tipo === filtroTipo;
                const cumpleUsuario = !filtroUsuario || cambio.usuario === filtroUsuario;
                
                const fechaCambio = new Date(cambio.fecha).toDateString();
                const cumpleFechaDesde = !fechaDesde || new Date(fechaDesde).toDateString() <= fechaCambio;
                const cumpleFechaHasta = !fechaHasta || new Date(fechaHasta).toDateString() >= fechaCambio;
                
                return cumpleTipo && cumpleUsuario && cumpleFechaDesde && cumpleFechaHasta;
            });
            
            mostrarListaAuditoria(auditoriaFiltrada);
        }

        function mostrarListaAuditoria(auditoriaFiltrada) {
            const container = document.getElementById('listaAuditoria');
            if (!container) return;
            
            if (auditoriaFiltrada.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No hay cambios que coincidan con los filtros</p>';
                return;
            }
            
            let html = '';
            auditoriaFiltrada.forEach(cambio => {
                const fecha = new Date(cambio.fecha).toLocaleString();
                const tipoColor = cambio.tipo === 'proceso' ? '#667eea' : 
                                 cambio.tipo === 'actividad' ? '#38a169' : 
                                 cambio.tipo === 'sistema' ? '#f59e0b' : '#3182ce';
                
                html += `
                    <div style="border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin-bottom: 10px; background: #f7fafc; border-left: 4px solid ${tipoColor};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <span style="background: ${tipoColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-right: 10px;">${cambio.tipo.toUpperCase()}</span>
                                <strong>${cambio.accion.toUpperCase()}</strong>
                            </div>
                            <span style="color: #666; font-size: 12px;">${fecha}</span>
                        </div>
                        <p style="margin-bottom: 8px;">${cambio.descripcion}</p>
                        <p style="color: #666; font-size: 14px;"><strong>Usuario:</strong> ${cambio.usuario}</p>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Funci√≥n para actualizar dashboard
        function actualizarDashboard() {
            document.getElementById('totalProcesos').textContent = procesos.length;
            
            const detecciones = detectarAutomaticamente();
            const duplicidadesProc = detecciones.filter(d => d.tipo === 'proceso').length;
            document.getElementById('duplicidadesEncontradas').textContent = duplicidadesProc;
            
            const sistemasRedundantes = detecciones.filter(d => d.tipo === 'sistema').length;
            const ahorrosPotenciales = Math.min(30, duplicidadesProc * 5 + sistemasRedundantes * 3);
            document.getElementById('ahorrosPotenciales').textContent = `${ahorrosPotenciales}%`;
            
            const accionesCompletadas = accionesMejora.filter(a => a.estado === 'Completada').length;
            document.getElementById('accionesCompletadas').textContent = accionesCompletadas;
            
            // Calcular costos con monedas
            const costoTotalSistemas = costosSistemas.reduce((sum, c) => {
                let costoMensual = c.costoTotal;
                if (c.frecuenciaPago === 'Anual') {
                    costoMensual = c.costoTotal / 12;
                }
                return sum + costoMensual;
            }, 0);
            
            document.getElementById('costoTotalSistemas').textContent = `${Math.round(costoTotalSistemas).toLocaleString()}`;
            
            const totalLicencias = costosSistemas.reduce((sum, c) => sum + (c.numLicencias || 0), 0);
            document.getElementById('totalLicencias').textContent = totalLicencias;
            
            const costoPorUsuario = totalLicencias > 0 ? costoTotalSistemas / totalLicencias : 0;
            document.getElementById('costoPorUsuario').textContent = `${costoPorUsuario.toFixed(2)}`;
            
            const ahorroAcumulado = accionesMejora
                .filter(a => a.estado === 'Completada')
                .reduce((sum, a) => sum + (a.ahorroEstimado || 0), 0);
            document.getElementById('ahorroAcumulado').textContent = `${ahorroAcumulado.toLocaleString()}`;
        }

        // Funciones de registro de cambios
        function registrarCambio(tipo, accion, descripcion, datosAnteriores = null, datosNuevos = null) {
            const cambio = {
                id: Date.now(),
                fecha: new Date().toISOString(),
                usuario: usuarioActual.nombre,
                tipo: tipo,
                accion: accion,
                descripcion: descripcion,
                datosAnteriores: datosAnteriores,
                datosNuevos: datosNuevos
            };
            
            auditoria.unshift(cambio);
            actualizarEstadisticasAuditoria();
        }

        // Funciones auxiliares
        function mostrarAlerta(mensaje, tipo) {
            const alertaTemp = document.createElement('div');
            alertaTemp.className = `alert ${tipo}`;
            alertaTemp.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 1000; max-width: 300px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);';
            alertaTemp.textContent = mensaje;
            document.body.appendChild(alertaTemp);
            
            setTimeout(() => {
                alertaTemp.remove();
            }, 3000);
        }

        function exportarExcel() {
            let csv = "√Årea,Puesto,Proceso,Sistemas,Tiempo (min),Frecuencia,Actividades\n";
            procesos.forEach(p => {
                const actividades = p.actividades ? p.actividades.join('; ') : '';
                const sistemas = Array.isArray(p.sistemas) ? p.sistemas.join('; ') : p.sistemas;
                csv += `"${p.area}","${p.puesto || ''}","${p.descripcion}","${sistemas}",${p.tiempo},"${p.frecuencia}","${actividades}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `procesos_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            mostrarAlerta('üìä Datos exportados correctamente', 'success');
        }

        function exportarTodo() {
            exportarExcel();
        }

        function aplicarFiltros() {
            mostrarVistaProcesosYFlujos();
        }

        function limpiarFiltros() {
            const filtros = ['filtroArea', 'filtroPuesto', 'filtroEstado', 'filtroPalabra'];
            filtros.forEach(filtroId => {
                const filtro = document.getElementById(filtroId);
                if (filtro) filtro.value = '';
            });
            mostrarVistaProcesosYFlujos();
        }

        // Modales
        function mostrarModalNuevaActividad() {
            const modal = document.createElement('div');
            modal.id = 'modalNuevaActividad';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 15px; padding: 30px; max-width: 400px; width: 90%;">
                        <h3 style="margin-bottom: 20px;">‚ûï Agregar Nueva Actividad</h3>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Nombre de la Actividad:</label>
                            <input type="text" id="nuevaActividadInput" placeholder="Ej: Gestionar Proveedores" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 5px;">
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="agregarNuevaActividadDesdeModal()" style="flex: 1; background: #38a169; color: white; border: none; border-radius: 8px; padding: 12px; cursor: pointer; font-weight: 600;">‚úÖ Agregar</button>
                            <button onclick="cerrarModalNuevaActividad()" style="flex: 1; background: #e53e3e; color: white; border: none; border-radius: 8px; padding: 12px; cursor: pointer; font-weight: 600;">‚ùå Cancelar</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('nuevaActividadInput').focus();
        }

        function agregarNuevaActividadDesdeModal() {
            const nuevaActividad = document.getElementById('nuevaActividadInput').value.trim();
            if (nuevaActividad && !actividades.includes(nuevaActividad)) {
                actividades.push(nuevaActividad);
                
                registrarCambio('actividad', 'crear', `Nueva actividad creada desde modal: ${nuevaActividad}`, null, { nombre: nuevaActividad });
                
                crearMatriz();
                actualizarFiltrosAnalisis();
                cerrarModalNuevaActividad();
                
                actividadesSeleccionadasTemp.push(nuevaActividad);
                actualizarVistaActividadesSeleccionadas();
                
                mostrarAlerta('‚úÖ Actividad agregada y seleccionada', 'success');
            } else if (actividades.includes(nuevaActividad)) {
                mostrarAlerta('‚ùå Esta actividad ya existe', 'alert');
            } else {
                mostrarAlerta('‚ùå Ingresa un nombre para la actividad', 'alert');
            }
        }

        function cerrarModalNuevaActividad() {
            const modal = document.getElementById('modalNuevaActividad');
            if (modal) modal.remove();
        }

        function mostrarModalNuevaFuente(tipo) {
            const titulo = tipo === 'recibe' ? 'Nueva Fuente de Informaci√≥n' : 'Nuevo Destino de Informaci√≥n';
            const placeholder = tipo === 'recibe' ? 'Ej: √Årea de Ventas' : 'Ej: Sistema de Facturaci√≥n';
            
            const modal = document.createElement('div');
            modal.id = 'modalNuevaFuente';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 15px; padding: 30px; max-width: 400px; width: 90%;">
                        <h3 style="margin-bottom: 20px;">‚ûï ${titulo}</h3>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Nombre:</label>
                            <input type="text" id="nuevaFuenteInput" placeholder="${placeholder}" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 5px;">
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="agregarNuevaFuente('${tipo}')" style="flex: 1; background: #38a169; color: white; border: none; border-radius: 8px; padding: 12px; cursor: pointer; font-weight: 600;">‚úÖ Agregar</button>
                            <button onclick="cerrarModalFuente()" style="flex: 1; background: #e53e3e; color: white; border: none; border-radius: 8px; padding: 12px; cursor: pointer; font-weight: 600;">‚ùå Cancelar</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('nuevaFuenteInput').focus();
        }

        function agregarNuevaFuente(tipo) {
            const nuevaFuente = document.getElementById('nuevaFuenteInput').value.trim();
            if (nuevaFuente) {
                if (tipo === 'recibe') {
                    if (!fuentesInfoRecibe.includes(nuevaFuente)) {
                        fuentesInfoRecibe.push(nuevaFuente);
                        fuentesInfoRecibeSeleccionadas.push(nuevaFuente);
                        actualizarVistaFuentesRecibeSeleccionadas();
                        registrarCambio('sistema', 'crear', `Nueva fuente de informaci√≥n agregada: ${nuevaFuente}`, null, { nombre: nuevaFuente, tipo: 'fuente_recibe' });
                        mostrarAlerta('‚úÖ Fuente agregada y seleccionada', 'success');
                    }
                } else {
                    if (!destinosInfoEntrega.includes(nuevaFuente)) {
                        destinosInfoEntrega.push(nuevaFuente);
                        destinosInfoEntregaSeleccionados.push(nuevaFuente);
                        actualizarVistaDestinosEntregaSeleccionados();
                        registrarCambio('sistema', 'crear', `Nuevo destino de informaci√≥n agregado: ${nuevaFuente}`, null, { nombre: nuevaFuente, tipo: 'destino_entrega' });
                        mostrarAlerta('‚úÖ Destino agregado y seleccionado', 'success');
                    }
                }
                cerrarModalFuente();
            } else {
                mostrarAlerta('‚ùå Ingresa un nombre v√°lido', 'alert');
            }
        }

        function cerrarModalFuente() {
            const modal = document.getElementById('modalNuevaFuente');
            if (modal) modal.remove();
        }

        function mostrarModalNuevoFormato(tipo) {
            const titulo = tipo === 'recibe' ? 'Nuevo Formato de Recepci√≥n' : 'Nuevo Formato de Entrega';
            
            const modal = document.createElement('div');
            modal.id = 'modalNuevoFormato';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 15px; padding: 30px; max-width: 400px; width: 90%;">
                        <h3 style="margin-bottom: 20px;">‚ûï ${titulo}</h3>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Formato:</label>
                            <input type="text" id="nuevoFormatoInput" placeholder="Ej: API REST" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 5px;">
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="agregarNuevoFormato('${tipo}')" style="flex: 1; background: #3182ce; color: white; border: none; border-radius: 8px; padding: 12px; cursor: pointer; font-weight: 600;">‚úÖ Agregar</button>
                            <button onclick="cerrarModalFormato()" style="flex: 1; background: #e53e3e; color: white; border: none; border-radius: 8px; padding: 12px; cursor: pointer; font-weight: 600;">‚ùå Cancelar</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('nuevoFormatoInput').focus();
        }

        function agregarNuevoFormato(tipo) {
            const nuevoFormato = document.getElementById('nuevoFormatoInput').value.trim();
            if (nuevoFormato && !formatosDisponibles.includes(nuevoFormato)) {
                formatosDisponibles.push(nuevoFormato);
                
                if (tipo === 'recibe') {
                    formatosRecibeSeleccionados.push(nuevoFormato);
                    actualizarVistaFormatosRecibeSeleccionados();
                } else {
                    formatosEntregaSeleccionados.push(nuevoFormato);
                    actualizarVistaFormatosEntregaSeleccionados();
                }
                
                registrarCambio('sistema', 'crear', `Nuevo formato agregado: ${nuevoFormato}`, null, { nombre: nuevoFormato, tipo: 'formato' });
                cerrarModalFormato();
                mostrarAlerta('‚úÖ Formato agregado y seleccionado', 'success');
            } else if (formatosDisponibles.includes(nuevoFormato)) {
                mostrarAlerta('‚ùå Este formato ya existe', 'alert');
            } else {
                mostrarAlerta('‚ùå Ingresa un nombre v√°lido', 'alert');
            }
        }

        function cerrarModalFormato() {
            const modal = document.getElementById('modalNuevoFormato');
            if (modal) modal.remove();
        }

        // Funci√≥n para inicializar eventos de costos
        function inicializarEventosCostos() {
            const costoPorUsoCheck = document.getElementById('costoPorUso');
            const costoPorLicenciaCheck = document.getElementById('costoPorLicencia');
            
            if (costoPorUsoCheck) {
                costoPorUsoCheck.addEventListener('change', function() {
                    document.getElementById('costoPorUsoValor').disabled = !this.checked;
                    if (!this.checked) document.getElementById('costoPorUsoValor').value = '';
                });
            }
            
            if (costoPorLicenciaCheck) {
                costoPorLicenciaCheck.addEventListener('change', function() {
                    const disabled = !this.checked;
                    document.getElementById('costoPorLicenciaValor').disabled = disabled;
                    document.getElementById('numLicencias').disabled = disabled;
                    if (!this.checked) {
                        document.getElementById('costoPorLicenciaValor').value = '';
                        document.getElementById('numLicencias').value = '';
                    }
                });
            }
        }

        // Funci√≥n principal de inicializaci√≥n
        function inicializar() {
            // Datos de ejemplo b√°sicos
            const ejemploProcesos = [
                {
                    id: 1,
                    area: 'Administraci√≥n',
                    puesto: 'Auxiliar Administrativo',
                    descripcion: 'Validar cliente nuevo',
                    sistemas: ['CRM', 'Excel'],
                    tiempo: 45,
                    frecuencia: 'Diario',
                    actividades: ['Validar Cliente', 'Verificar Datos'],
                    activo: true,
                    fechaCreacion: new Date().toISOString(),
                    usuarioCreacion: 'Sistema',
                    fechaModificacion: new Date().toISOString(),
                    usuarioModificacion: 'Sistema',
                    flujoInfo: {
                        fuentesRecibe: ['Clientes', '√Årea Comercial'],
                        destinosEntrega: ['Sistemas Externos'],
                        descripcionRecibe: 'Informaci√≥n de solicitudes de clientes nuevos',
                        descripcionEntrega: 'Cliente validado y aprobado',
                        formatosRecibe: ['Email', 'Sistema'],
                        formatosEntrega: ['Digital', 'PDF']
                    }
                },
                {
                    id: 2,
                    area: 'Comercial',
                    puesto: 'Ejecutivo de Ventas',
                    descripcion: 'Validar cliente nuevo',
                    sistemas: ['CRM'],
                    tiempo: 40,
                    frecuencia: 'Diario',
                    actividades: ['Validar Cliente', 'Verificar Datos'],
                    activo: true,
                    fechaCreacion: new Date().toISOString(),
                    usuarioCreacion: 'Sistema',
                    fechaModificacion: new Date().toISOString(),
                    usuarioModificacion: 'Sistema',
                    flujoInfo: {
                        fuentesRecibe: ['Clientes'],
                        destinosEntrega: ['√Årea Administrativa'],
                        descripcionRecibe: 'Solicitudes directas de clientes',
                        descripcionEntrega: 'Cliente pre-aprobado',
                        formatosRecibe: ['Sistema', 'WhatsApp'],
                        formatosEntrega: ['Digital', 'Email']
                    }
                }
            ];
            
            procesos.push(...ejemploProcesos);
            
            // Datos de costos con monedas
            costosSistemas.push(
                {
                    sistema: 'SAP',
                    descripcion: 'Sistema de planificaci√≥n empresarial',
                    moneda: 'MXN',
                    costoPorUso: false,
                    costoPorUsoValor: 0,
                    costoPorLicencia: true,
                    costoPorLicenciaValor: 2550,
                    numLicencias: 15,
                    costoTotal: 38250,
                    formaPago: 'Transferencia',
                    frecuenciaPago: 'Mensual',
                    otrosEspecificar: '',
                    id: 1,
                    fechaCreacion: new Date().toISOString(),
                    usuarioCreacion: 'Sistema'
                },
                {
                    sistema: 'CRM',
                    descripcion: 'Sistema de gesti√≥n de clientes',
                    moneda: 'MXN',
                    costoPorUso: true,
                    costoPorUsoValor: 500,
                    costoPorLicencia: true,
                    costoPorLicenciaValor: 50,
                    numLicencias: 10,
                    costoTotal: 1000,
                    formaPago: 'Tarjeta',
                    frecuenciaPago: 'Mensual',
                    otrosEspecificar: '',
                    id: 2,
                    fechaCreacion: new Date().toISOString(),
                    usuarioCreacion: 'Sistema'
                }
            );
            
            // Acciones de ejemplo
            accionesMejora.push(
                {
                    id: 1,
                    tipo: 'Eliminaci√≥n de Duplicidad',
                    estado: 'Completada',
                    descripcion: 'Centralizar validaci√≥n de clientes en el √°rea comercial',
                    duplicidadAbordada: 'proceso_1_2',
                    accionesTomadas: 'Se unificaron los procesos y se capacit√≥ al equipo',
                    responsable: 'Gerente Comercial',
                    fechaObjetivo: '2024-02-15',
                    ahorroEstimado: 1200,
                    moneda: 'MXN',
                    fechaCreacion: new Date('2024-01-15').toISOString(),
                    usuarioCreacion: 'Administrador Sistema',
                    fechaCompletado: new Date('2024-02-10').toISOString()
                }
            );
            
            // Actualizar interfaz
            document.getElementById('usuarioActualNombre').textContent = usuarioActual.nombre;
            document.getElementById('usuarioActualRol').textContent = usuarioActual.rol;
            document.getElementById('ultimaSesion').textContent = new Date().toLocaleString();
            
            actualizarSelectsConfiguracion();
            crearMatriz();
            inicializarEventosCostos();
            
            // Registrar inicializaci√≥n
            registrarCambio('sistema', 'inicializar', 'Sistema SIAP inicializado completamente', null, { 
                version: '5.0 - Corregido', 
                usuario: usuarioActual.nombre,
                mejoras: 'Todas las mejoras de la versi√≥n 2 y 3 implementadas correctamente'
            });
            
            actualizarDashboard();
            mostrarVistaProcesosYFlujos();
            generarDeteccionesAutomaticas();
            mostrarAccionesMejora();
            mostrarAuditoria();
            
            // Llenar matriz autom√°ticamente con datos de ejemplo
            setTimeout(() => {
                procesos.filter(p => p.activo).forEach(proceso => {
                    if (proceso.actividades) {
                        proceso.actividades.forEach(actividad => {
                            const checkbox = document.querySelector(`input[data-area="${proceso.area}"][data-actividad="${actividad}"]`);
                            if (checkbox) checkbox.checked = true;
                        });
                    }
                });
                verificarDuplicidadesEnMatriz();
                
                setTimeout(() => {
                    mostrarAlerta('üéâ SIAP v5.0 CORREGIDO - Sistema completamente funcional con todas las mejoras implementadas', 'success');
                }, 1000);
            }, 500);
        }

        // Inicializar al cargar la p√°gina
        window.onload = inicializar;
    </script>
</body>
</html>